<!doctype html><html prefix="og: http://ogp.me/ns#" lang=en-us><head itemscope itemtype=https://hedge-ops.com/><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:locale" content="en"><meta name=language content="en"><title itemprop=name>Policyfiles &#183; Michael Hedgpeth</title><meta property="og:title" content="Policyfiles &#183; Michael Hedgpeth"><meta name=twitter:title content="Policyfiles &#183; Michael Hedgpeth"><meta itemprop=name content="Policyfiles &#183; Michael Hedgpeth"><meta name=application-name content="Michael Hedgpeth"><meta property="og:site_name" content="Michael Hedgpeth"><base href=https://hedge-ops.com/policyfiles/><link rel=canonical href=https://hedge-ops.com/policyfiles/ itemprop=url><meta name=url content="https://hedge-ops.com/policyfiles/"><meta name=twitter:url content="https://hedge-ops.com/policyfiles/"><meta property="og:url" content="https://hedge-ops.com/policyfiles/"><meta itemprop=image content="https://hedge-ops.com/images/michael.jpg"><meta property="og:image" content="https://hedge-ops.com/images/michael.jpg"><meta name=twitter:image content="https://hedge-ops.com/images/michael.jpg"><meta name=twitter:image:src content="https://hedge-ops.com/images/michael.jpg"><meta name=twitter:card content="summary_large_image"><meta property="og:type" content="article"><meta itemprop=description content="Recently at the Chef Community Summit, I proposed a topic on Policyfiles. Policyfiles are a new way to handle dependency and change management for your Chef inf"><meta property="og:description" content="Recently at the Chef Community Summit, I proposed a topic on Policyfiles. Policyfiles are a new way to handle dependency and change management for your Chef inf"><meta name=description content="Recently at the Chef Community Summit, I proposed a topic on Policyfiles. Policyfiles are a new way to handle dependency and change management for your Chef inf"><meta name=twitter:description content="Recently at the Chef Community Summit, I proposed a topic on Policyfiles. Policyfiles are a new way to handle dependency and change management for your Chef inf"><meta property="article:published_time" content="2016-11-02T08:00:00Z"><meta name=twitter:label1 value="Reading time"><meta name=twitter:data1 value="12 minutes"><meta name=twitter:label2 value=Published><meta name=twitter:data2 value="November 2, 2016"><meta property="article:tag" content="chef"><meta property="og:updated_time" content="2016-11-02T08:00:00Z"><meta property="og:article:author" content="Michael"><meta property="article:author" content="Michael"><meta name=author content="Michael"><meta name=generator content="Hugo 0.72.0"><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com/ crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel=stylesheet><link rel=stylesheet href=https://hedge-ops.com/css/styles.min.ef433e47a104e30937dfad230e28b6dd329c9b4fe18ff4925850da1f24df3133.css integrity="sha256-70M+R6EE4wk3360jDii23TKcm0/hj/SSWFDaHyTfMTM="><link href=/index.xml rel=alternate type=application/rss+xml title="Michael Hedgpeth"><script src=https://cdnjs.cloudflare.com/ajax/libs/turbolinks/5.2.0/turbolinks.js></script></head><body class="bg-gradient flex flex-col min-h-screen"><header id=header class="w-full m-0 fixed z-10 transition-all duration-300 ease-in-out border-t-4 border-gray-300 backdrop-filter-blur"><div id=header-container class="max-w-7xl mx-auto p-6 flex items-center flex-wrap lg:flex-no-wrap relative justify-between"><a href=https://hedge-ops.com/ class="tracking-tighter leading-10 text-3xl font-semibold text-gray-600 flex flex-shrink-0">Michael Hedgpeth</a><div class="block lg:hidden mx-2"><button class="nav-button w-10 h-10 justify-center flex items-center opacity-75 hover:opacity-100 transition duration-300 ease-in-out"><svg class="fill-current h-4 w-4" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"/></svg></button>
<button class="hidden nav-button w-10 h-10 justify-center flex items-center opacity-75 hover:opacity-100 transition duration-300 ease-in-out"><svg class="fill-current h-4 w-4" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Close menu</title><polygon points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2" transform="rotate(45 10 10)"/></svg></button></div><div class="absolute right-8 top-16 lg:relative lg:right-0 lg:top-0 flex flex-col lg:flex-row items-center rounded-md bg-white shadow lg:bg-transparent lg:shadow-none"><nav id=nav-social-links class="p-4 lg:p-0 text-gray-600 hidden lg:block lg:order-last w-full lg:w-auto lg:ml-3"><ul class="flex justify-end"><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Twitter href=https://www.twitter.com/michaelhedgpeth rel=me><svg class="fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Twitter</title><path d="M6.29 18.25c7.55.0 11.67-6.25 11.67-11.67v-.53c.8-.59 1.49-1.3 2.04-2.13-.75.33-1.54.55-2.36.65a4.12 4.12.0 001.8-2.27c-.8.48-1.68.81-2.6 1a4.1 4.1.0 00-7 3.74 11.65 11.65.0 01-8.45-4.3 4.1 4.1.0 001.27 5.49C2.01 8.2 1.37 8.03.8 7.7v.05a4.1 4.1.0 003.3 4.03 4.1 4.1.0 01-1.86.07 4.1 4.1.0 003.83 2.85A8.23 8.23.0 010 16.4a11.62 11.62.0 006.29 1.84"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Github href=https://www.github.com/mhedgpeth rel=me><svg class="fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>GitHub</title><path d="M10 0A10 10 0 006.84 19.49c.5.1.68-.22.68-.48l-.01-1.7c-2.78.6-3.37-1.34-3.37-1.34-.46-1.16-1.11-1.47-1.11-1.47-.9-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.9 1.52 2.34 1.08 2.91.83.1-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.94.0-1.1.39-1.99 1.03-2.69a3.6 3.6.0 01.1-2.64s.84-.27 2.75 1.02a9.58 9.58.0 015 0c1.91-1.3 2.75-1.02 2.75-1.02.55 1.37.2 2.4.1 2.64.64.7 1.03 1.6 1.03 2.69.0 3.84-2.34 4.68-4.57 4.93.36.31.68.92.68 1.85l-.01 2.75c0 .26.18.58.69.48A10 10 0 0010 0"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Linkedin href=https://linkedin.com/in/michael-hedgpeth rel=me><svg class="fill-current w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Feed href=/index.xml><svg class="fill-current w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>RSS</title><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg></a></li></ul></nav><nav id=nav-menu class="p-4 lg:p-0 hidden lg:block w-full lg:w-auto text-gray-600"><ul class="w-full flex flex-col lg:flex-row justify-end items-end lg:items-center"><li class="flex my-2 lg:my-2 mx-1 lg:mx-2"><a title=About class="uppercase font-bold lg:py-2 lg:px-3 rounded text-sm opacity-75 hover:opacity-100 transition duration-300 ease-in-out" href=/about>About</a></li><li class="flex my-2 lg:my-2 mx-1 lg:mx-2"><a title=Speaking class="uppercase font-bold lg:py-2 lg:px-3 rounded text-sm opacity-75 hover:opacity-100 transition duration-300 ease-in-out" href=/speaking>Speaking</a></li></ul></nav></div></div></header><main class="flex-1 mt-12 max-w-3xl mt-32 mx-auto text-gray-700 w-full"><div id=reading-progress-bar role=presentation class="fixed z-10 top-0 left-0 h-1 bg-gray-700"></div><article class=article><header class="text-center pt-10 pb-6"><small class="text-center text-sm"><time class=text-gray-500 datetime=2016-11-02T08:00:00+00:00>November 2, 2016</time>
<a href=https://hedge-ops.com/tags/chef/ class="inline-flex items-center px-4 py-1 rounded-full no-underline bg-orange-100 text-orange-800 hover:bg-orange-300 ml-4">chef</a></small><h1 class="leading-9 text-center"><a href=https://hedge-ops.com/policyfiles/ class="no-underline inline-block text-black relative"><div class=dots aria-hidden=true></div>Policyfiles</a></h1></header><div class=article__content><div class=full-width><img src=/images/feature-policyfiles.jpg alt=Policyfiles></div><p>Recently at the <a href=https://summit.chef.io/seattle/>Chef Community Summit</a>, I proposed a topic on <a href=https://docs.chef.io/policyfile.html>Policyfiles</a>. Policyfiles are a new way to handle dependency and change management for your Chef infrastructure. During the session it became clear that there wasn&rsquo;t enough information out there on how and why to use Policyfiles. I realized that an introduction to Policyfiles for the Chef Community was far overdue and committed to the session that I would market the feature through this blog post and future podcast episode on the Food Fight Show.</p><h1 id=why-policyfiles>Why Policyfiles?</h1><p>Early on in my Chef adoption, <a href=/my-advice-for-chef-in-large-corporations/>it became clear that I couldn&rsquo;t deliver on the strict change management controls within the legacy Chef workflow without a lot of work</a>. With the traditional Chef workflow, you can update a cookbook in production and all of the sudden all of your nodes are running different code. Was it tested this way before? Well let&rsquo;s hope so! &ldquo;Let&rsquo;s hope so&rdquo; doesn&rsquo;t cut it when you&rsquo;re dealing with an enterprise as large and complicated as NCR. Our entire business rests on the trust our customers put into us to securely handle their financial transactions.</p><p><strong>With Policyfiles you can guarantee that the exact same cookbooks that ran in earlier environments will run in later environments.</strong> You get real change management that is inuitive and doesn&rsquo;t leave you trying to explain the intricacies of Chef dependency management in an outage call. <strong>It just works.</strong></p><p>Another benefit we get out of Policyfiles is <strong>it makes Chef easy to learn</strong>. Rather than burdening the user with a complex structure of roles, cookbooks, environments, and pinning, I can simply show them a Policyfile and show them the workflow I outline below. This greatly speeds up time I spend teaching my colleagues Chef. I challenge the Chef veterans who are reading this to explain Chef to someone using the workflow outlined below and watch the magic: you&rsquo;ll see that they really get it at the end, and they went from nothing to a working solution far more quickly than you&rsquo;re used to.</p><p>That adoption cost has a real effect on the future of Chef. If there are less people in the community due to high barriers to entry, there are less <a href=https://supermarket.chef.io>community cookbooks</a> and less opportunities for Chef Inc. to monetize the platform and therefore invest more into it. So, even if you have already defined complicated workarounds that address the deficiencies in the legacy workflow, I encourage you to adopt and support it in situations it makes sense. Keep an open mind.</p><h1 id=policyfile-workflow>Policyfile Workflow</h1><p>The best way to understand the Policyfile feature is by walking through an example. We&rsquo;ll configure a webserver for one of our apps with Policyfiles.</p><h2 id=policyfilerb-file>Policyfile.rb file</h2><p>The first thing we&rsquo;ll start with is the <code>Policyfile.rb</code> itself. <strong>A Policyfile declares the name, run list, sources, and attributes for a node or group of nodes.</strong></p><p>Though <code>Policyfile.rb</code> is the default name for the policyfile, you can name it whatever you want. On our projects, there are usually many Policyfiles: we could have <code>myapp-webserver.rb</code> and <code>myapp-database.rb</code>. The name that you use has to be unique in your Chef server.</p><p>If you&rsquo;re just starting out, the Policyfile will go in your application&rsquo;s cookbook repo. As you advance, you&rsquo;ll probably want to separate it into its own repository, because the frequent revisions of the lock file outlined below will clutter up your history. At this point we have about half and half Policyfiles in cookbooks vs. their own repository.</p><h3 id=creating-the-policyfile>Creating the Policyfile</h3><p>It&rsquo;s always good to start out with a generated policyfile to make the adoption a little easier. There are two ways to do this:</p><p>First you could generate the Policyfile directly:</p><pre><code>chef generate policyfile Policyfile.rb
</code></pre><p>Or you can add the <code>-P</code> flag to the <code>chef generate cookbook</code> command:</p><pre><code>chef generate cookbook myapp -P
</code></pre><p>Either way you have a Policyfile generated and ready to go.</p><h3 id=basic-contents>Basic Contents</h3><p>Once the Policyfile is generated, it should look like this:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#0086b3>name</span> <span style=color:#d14>&#39;webserver&#39;</span> <span style=color:#998;font-style:italic># will be used later in Client.rb on the Node</span>
default_source <span style=color:#990073>:supermarket</span>, <span style=color:#d14>&#39;https://supermarket.mycompany.com&#39;</span> <span style=color:#998;font-style:italic># this uses only internal cookbooks</span>
 
run_list <span style=color:#d14>&#39;recipe[myapp::webserver]&#39;</span> <span style=color:#998;font-style:italic># the run list of recipes; won&#39;t contain roles</span>

<span style=color:#998;font-style:italic># where to find cookbooks that are outside of the default_source</span>
cookbook <span style=color:#d14>&#39;myapp&#39;</span>, <span style=color:#990073>git</span>: <span style=color:#d14>&#39;https://git.mycompany.com/devops/myapp&#39;</span> 
</code></pre></div><p>Let&rsquo;s go over the elements:</p><table><tr><th>Element</th><th>Description</th></tr><tr><td>name</td><td>used to reference this policyfile on the Chef server and it must be unique. As I said above, you probably want to come up with a naming convention for your Policies. We use <code>applicationname-role.rb</code> for ours (like <code>myapp-webserver</code>).</td></tr><tr><td>default_source</td><td>This is where we get all of our cookbooks if they're not specifically declared in the lower section. This will usually be a supermarket.</td></tr><tr><td>run_list</td><td>In this model you don't declare a <code>run_list</code> on the client itself. This maintains consistency between environments.</td></tr><tr><td>cookbook</td><td>declares the non-default location where chef can find this cookbook. In this case we'll find it on the git server.</td></tr></table><h3 id=environment-specific-settings>Environment-specific settings</h3><p>Pretty quickly you&rsquo;ll run into situations where you have environment specific settings. This is better avoided if at all possible; one possible solution is <a href=https://youtu.be/TEvElu6Wnbc>to use Consul</a> to deal with environment-specific settings. However, <a href=/all-or-nothing-changes/>it&rsquo;s also important to make progress</a>, so you&rsquo;ll probably want to declare the settings in a structure that includes the <code>policy_group</code>.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#998;font-style:italic># in the Policyfile:</span>
default<span style=color:#000;font-weight:700>[</span><span style=color:#d14>&#39;qa&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span> {
  <span style=color:#990073>myapp</span>: {
    <span style=color:#990073>database</span>: <span style=color:#d14>&#39;qaserver01&#39;</span>
  }
}
default<span style=color:#000;font-weight:700>[</span><span style=color:#d14>&#39;uat&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span> {
  <span style=color:#990073>myapp</span>: {
    <span style=color:#990073>database</span>: <span style=color:#d14>&#39;uatdbsrv32&#39;</span>
  }
}
default<span style=color:#000;font-weight:700>[</span><span style=color:#d14>&#39;production&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span> {
  <span style=color:#990073>myapp</span>: {
    <span style=color:#990073>database</span>: <span style=color:#d14>&#39;proddbsrv62&#39;</span>
  }
}
</code></pre></div><p>Then in our recipe code we can reference the <code>policy_group</code> and easily get to our setting:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>database <span style=color:#000;font-weight:700>=</span> node<span style=color:#000;font-weight:700>[</span>node<span style=color:#000;font-weight:700>.</span>policy_group<span style=color:#000;font-weight:700>][</span><span style=color:#d14>&#39;myapp&#39;</span><span style=color:#000;font-weight:700>][</span><span style=color:#d14>&#39;database&#39;</span><span style=color:#000;font-weight:700>]</span>
</code></pre></div><p>Or you could take it one step closer and include the <a href=https://github.com/poise/poise-hoist>poise-hoist</a> cookbook in your <code>run_list</code> and simply write:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#998;font-style:italic># with poise-hoist, you can&#39;t tell if you&#39;re using policyfiles</span>
database <span style=color:#000;font-weight:700>=</span> node<span style=color:#000;font-weight:700>[</span><span style=color:#d14>&#39;myapp&#39;</span><span style=color:#000;font-weight:700>][</span><span style=color:#d14>&#39;database&#39;</span><span style=color:#000;font-weight:700>]</span>
</code></pre></div><p>If you want to learn about this in more detail, check out <a href=/policyfile-attributes/>my follow up post</a> that dives into this more deeply.</p><h2 id=creation-of-the-policyfilelockjson-file>Creation of the Policyfile.lock.json file</h2><p>Now that you have a declaration of what you want to run on a machine and your environment-specific settings declared, it&rsquo;s time to create a point in time snapshot of <em>specific</em> dependencies Chef will use on a node. This is your actual policy and it is stored in your <code>Policyfile.lock.json</code> file. This is the file that your node will read to pull dependencies down and run them locally.</p><p>To generate your <code>Policyfile.lock.json</code> file, run:</p><pre><code>rm Policyfile.lock.json # remove any old lockfiles first
chef install Policyfile.rb 
</code></pre><p>This generates the following important attributes at the top of the file:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#d14>&#34;revision_id&#34;</span><span style=color:#a61717;background-color:#e3d2d2>:</span> <span style=color:#d14>&#34;6156a875a7c0eb06ce9gdc9e3d4f19809752942efd6dd20888ddd9fd8bbbd43b5&#34;</span><span style=color:#a61717;background-color:#e3d2d2>,</span>
<span style=color:#d14>&#34;name&#34;</span><span style=color:#a61717;background-color:#e3d2d2>:</span> <span style=color:#d14>&#34;platform&#34;</span><span style=color:#a61717;background-color:#e3d2d2>,</span>
<span style=color:#d14>&#34;run_list&#34;</span><span style=color:#a61717;background-color:#e3d2d2>:</span> [
  <span style=color:#d14>&#34;recipe[platform::default]&#34;</span>
]<span style=color:#a61717;background-color:#e3d2d2>,</span>
</code></pre></div><table><tr><th>Attribute</th><th>Description</th></tr><tr><td>revision_id</td><td>This is a <b>very</b> important field, that will tell you what version of the policy you are running on the chef server and during your chef run. By committing the <code>Policyfile.lock.json</code> file to source, you'll always be able to view <b>exactly</b> what runs on the node by referring back to the version of this file by this revision.</td></tr><tr><td>name</td><td>The policy name, which you will declare as a node attribute to declare which policy the node uses. This is the "logical" connection to the policy.</td></tr><tr><td>run_list</td><td>A fully expanded list of recipes that will run. With this generation there is no doubt over what will run. This is a major benefit of this over using roles or environments, where there can be a doubt, and thus confusion and potential disaster.</td></tr></table><p>Later down the file, we can see the output for one of our cookbooks:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#d14>&#34;windows&#34;</span><span style=color:#a61717;background-color:#e3d2d2>:</span> {
  <span style=color:navy>&#34;version&#34;</span>: <span style=color:#d14>&#34;1.40.0&#34;</span>,
  <span style=color:navy>&#34;identifier&#34;</span>: <span style=color:#d14>&#34;54a9b2515c853919c4953893997899584d4cefba&#34;</span>,
  <span style=color:navy>&#34;dotted_decimal_identifier&#34;</span>: <span style=color:#d14>&#34;23830481377985849.7253019596134776.168604533059514&#34;</span>,
  <span style=color:navy>&#34;cache_key&#34;</span>: <span style=color:#d14>&#34;windows-1.40.0-supermarket.mycompany.com&#34;</span>,
  <span style=color:navy>&#34;origin&#34;</span>: <span style=color:#d14>&#34;https://supermarket.mycompany.com:443/api/v1/cookbooks/windows/versions/1.40.0/download&#34;</span>,
  <span style=color:navy>&#34;source_options&#34;</span>: {
    <span style=color:navy>&#34;artifactserver&#34;</span>: <span style=color:#d14>&#34;https://supermarket.mycompany.com:443/api/v1/cookbooks/windows/versions/1.40.0/download&#34;</span>,
    <span style=color:navy>&#34;version&#34;</span>: <span style=color:#d14>&#34;1.40.0&#34;</span>
  }
}
</code></pre></div><p>You can see here that there is a very specific declaration of the dependency for the cookbook. This is in the policyfile so if we wanted to regenerate all dependencies from this <code>Policyfile.lock.json</code>, we can do so as long as we still have connectivity to the repositories on which the dependencies are stored. It&rsquo;s important to also note that the <code>identifier</code> here <em>also</em> doubles as a checksum of the cookbook contents. If the contents change, but <strong>nothing else</strong> changes, then <code>chef-client</code> will refuse to run the policy. This is a tamper-proof mechanism that increases your ability to predict what code will run on your servers.</p><p>Remember, we are running this code with elevated privileges, so if you&rsquo;re running in production, it&rsquo;s incredibly important to predict what will happen. <strong>You can&rsquo;t easily predict outcomes without policyfiles.</strong></p><h2 id=pushing-it-to-the-chef-server>Pushing it to the Chef Server</h2><p>Now that we have a lockfile built, it&rsquo;s time to make the policy active for our nodes. If our nodes, Chef Server, and development machine are all on the same network, we can simply push the policy to the Chef Server directly. If you&rsquo;re doing this within CI and it&rsquo;s possible on another agent or at another time, you&rsquo;ll want to run <code>chef install</code> first to ensure the cookbooks are locally cached. The <code>chef install</code> command will <em>not</em> replace the lockfile if it already exists.</p><pre><code>chef install Policyfile.rb # to ensure dependencies are loaded
chef push qa Policyfile.rb
</code></pre><p>This will push the policy and all dependencies declared in the lockfile to the Chef Server for the <code>qa</code> policy group. Once you run this command, you can guarantee that you can run it on a node. No more remembering to upload a specific dependency; it&rsquo;s simply there for you to run and will include the exact same cookbooks that are in the lockfile.</p><p>The <code>qa</code> above is your policy group. <strong>A policy group, similar to an environment, is a logical group of nodes that you want to have the same policy.</strong> Since many times you&rsquo;ll be using the same Chef Server to manage multiple environments, you&rsquo;ll want to split your nodes into different policy groups so you can make sure that you are flowing policy changes through a pipeline before they get to production.</p><p>Also note that you should <em>never</em> run the <code>chef update</code> command. Results of this are not easily predicatable, so I&rsquo;ve stayed away from it. If you need to regenerate a lockfile, remove the old one and run <code>chef install</code>. If you want to push the policy, ensure that the dependencies are loaded with <code>chef install</code> and then push it with <code>chef push</code>.</p><h2 id=setting-up-chef-client>Setting up Chef Client</h2><p>To get your node to have the appropriate policy name and group, you need to update its attributes. The easiest way to do this is when bootstrapping the node itself:</p><pre><code>knife bootstrap mywebserver --policy-group qa --policy-name webserver
</code></pre><p>If you, like me, have a node-centric bootstrapping mechanism, your bootstrapper will need to update node attributes using the <code>-j</code> flag. First create attributes with the <code>policy_name</code> and <code>policy_group</code> in them:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#a61717;background-color:#e3d2d2>#</span> <span style=color:#a61717;background-color:#e3d2d2>attributes.json</span>
{
  <span style=color:navy>&#34;policy_name&#34;</span>: <span style=color:#d14>&#34;webserver&#34;</span>,
  <span style=color:navy>&#34;policy_group&#34;</span>: <span style=color:#d14>&#34;qa&#34;</span>
}
</code></pre></div><p>And then run:</p><pre><code>chef-client -j attributes.json 
</code></pre><p>From there your node will use that policy.</p><p>I used to manually add the settings to <code>client.rb</code> directly, but now know that this is bad because it will mean I have to manually update them again if I ever need to change it. Setting them in the node attributes directly allows me to change them remotely on the Chef Server.</p><h2 id=packaging-it-for-air-gapped-environments>Packaging it for Air Gapped environments</h2><p>You&rsquo;re not always going to have a connected Chef Server available and may need to transfer your policy to an Air-Gapped environment. Policyfiles make this process incredibly easy because they package all dependencies into one file. To do this, start by running:</p><pre><code>chef export Policyfile.rb . -a
</code></pre><p>This will export the all cookbooks listed in the <code>Policyfile.lock.json</code> and the lockfile itself into a single archive. Now you can transfer this file to the air-gapped environment however you are used to doing so.</p><p>This is an essential element of the benefits to Policyfiles in a security-conscious environment: <strong>You get to keep the same controls you have in place while you begin implementing Chef!</strong> Yes, eventually you&rsquo;ll do a CI/CD pipeline like <a href=https://docs.chef.io/workflow.html>Chef Workflow</a> but <strong>don&rsquo;t let that get in the way of getting value out of Chef!</strong> That&rsquo;s the absolute worst thing you could do. Create value early and often. Work around your existing controls and change the parts that you have buy-in to change. Repeat that and soon enough you&rsquo;ll be in a good place.</p><p>Once you&rsquo;ve generated the archive and transferred the file to your air-gapped environment, it&rsquo;s time to load it up on the Chef Server, you can run:</p><pre><code>chef push-archive qa Policyfile-6156a875a7c0eb06ce9gdc9e3d4f19809752942efd6dd20888ddd9fd8bbbd43b5.tar.gz
</code></pre><p>Again, we&rsquo;re declaring a policy group here, but this is pretty much the same as the <code>chef push</code> command above. Your policy is active for that policy group on the Chef Server, and you can rest assured that all cookbooks are there ready to be used.</p><h2 id=pipeline-management>Pipeline management</h2><p>We&rsquo;re going to want to add this workflow to a pipeline that we can manage in Jenkins or TeamCity. The process will roughly consist of:</p><ol><li>Cookbook builds, which include running Test Kitchen, ChefStyle linting, etc.</li><li>Promotion to an internal supermarket (if you have one)</li><li>Updating pinned versions of those cookbooks in the Policyfile or in specific cookbooks through a pull request</li><li>Whenever the Policyfile.rb changes, or on demand, or when dependencies complete, rebuild the <code>Policyfile.lock.json</code> file and check it in</li><li>Push the <code>Policyfile.lock.json</code> file to the Chef Server for locally available resources. If there is a pipeline, push to one policy group at a time and make sure they work before pushing out even further.</li><li>If there isn&rsquo;t a Chef Server connected to your build environment, post the policyfile archive to be loaded by your air-gapped environment. Much of this can be automated, but you&rsquo;ll find that there is a step where you have to physically deal with the air-gapped environment (by definition).</li></ol><h2 id=which-policy-is-active>Which Policy is Active?</h2><p>As I said before, this revision id that is generated as a part of your lockfile will be the single identifier for this policy from here on out. So to see which policy is active you can simply run:</p><pre><code>chef show-policy webserver
</code></pre><p>Which will generate:</p><pre><code>webserver
========

* qa:  6156a875a7
</code></pre><p>Here you have the first ten characters of your revision id, and it is clear the exact versioin of the policy that is active for the <code>qa</code> group. If you&rsquo;re checking in your lockfiles through a pipeline, this revision id should be stored with your lockfile in your git repo and thus you can understand when it was created. You have a great understanding of the exact changes that went into your environment.</p><p>Similarly, when you run <code>chef-client</code>, you see exactly the revision id and policy that is used:</p><pre><code>PS D:\chef&gt; chef-client
Starting Chef Client, version 12.11.18
Using policy 'webserver' at revision '6156a875a7c0eb06ce9gdc9e3d4f19809752942efd6dd20888ddd9fd8bbbd43b5'
</code></pre><p>So at all levels you have repeatability and traceability of all changes.</p><h1 id=conclusion>Conclusion</h1><p>The Chef Community should adopt Policyfiles because they are easier to learn than the legacy workflow, give you better control change management, and are more flexible for security-concious implementations. Hopefully this blog post will serve as an impetus for broader adoption of the feature and eventual inclusion into the Automate product suite.</p></div><section class="my-5 pt-10 pb-5 border-t border-gray-400 flex items-center"><img alt="Avatar photo" class="border border-gray-400 p-1 w-10 h-10 rounded-full mr-3" src=/images/michael.jpg>
<span class=flex-grow>Michael Hedgpeth</span>
<a href="http://twitter.com/share?url=https%3a%2f%2fhedge-ops.com%2fpolicyfiles%2f&text=Policyfiles&via=michaelhedgpeth" class="text-white text-xs font-bold rounded-md no-underline flex items-center px-3 py-2 bg-twitter hover:color-white hover:opacity-75 no-underline"><svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Twitter</title><path d="M6.29 18.25c7.55.0 11.67-6.25 11.67-11.67v-.53c.8-.59 1.49-1.3 2.04-2.13-.75.33-1.54.55-2.36.65a4.12 4.12.0 001.8-2.27c-.8.48-1.68.81-2.6 1a4.1 4.1.0 00-7 3.74 11.65 11.65.0 01-8.45-4.3 4.1 4.1.0 001.27 5.49C2.01 8.2 1.37 8.03.8 7.7v.05a4.1 4.1.0 003.3 4.03 4.1 4.1.0 01-1.86.07 4.1 4.1.0 003.83 2.85A8.23 8.23.0 010 16.4a11.62 11.62.0 006.29 1.84"/></svg>Tweet</a></section><section class="my-5 py-5 relative"><h2>Interactions</h2></section></article><aside class=flex><a class="w-full md:w-1/2 flex flex-col items-center py-7 px-3 no-underline rounded-md hover:bg-white transition duration-300 ease-in-out" href=/policyfile-attributes/><span class="border border-gray-6 text-xs rounded-md mb-2 uppercase font-bold py-2 px-3">Read this next</span>
<span class=text-center>Policyfile Attributes</span></a>
<a class="w-full md:w-1/2 flex flex-col items-center py-7 px-3 no-underline rounded-md hover:bg-white transition duration-300 ease-in-out" href=/chef-with-windows/><span class="border border-gray-6 text-xs rounded-md mb-2 uppercase font-bold py-2 px-3">You might enjoy</span>
<span class=text-center>Chef with Windows</span></a></aside></main><footer class="w-full max-w-7xl mx-auto text-center border-t border-gray-200 py-9 px-3 mt-9 pin-b text-sm text-gray-500">Made with <a href=https://gohugo.io class="underline transition duration-300 ease-in-out hover:text-blue-600">Hugo</a> and <a href=https://github.com/leonardofaria/bento class="underline transition duration-300 ease-in-out hover:text-blue-600">Bento theme</a>.
Copyright Â© 2020 Michael Hedgpeth</footer><script>var initMenu=()=>{var navButtons=document.querySelectorAll('.nav-button');var navMenu=document.querySelector('#nav-menu');var navSocialLinks=document.querySelector('#nav-social-links');for(var button of navButtons){button.addEventListener('click',()=>{console.log('click')
navMenu.classList.toggle("hidden");if(navSocialLinks){navSocialLinks.classList.toggle("hidden");}
for(var navButton of navButtons){navButton.classList.toggle("hidden");};});}}
document.addEventListener('turbolinks:load',initMenu());</script><script>var initHeader=()=>{let scrollPos=window.scrollY;var header=document.querySelector('#header');var headerContainer=document.querySelector("#header-container");var readingProgressBar=document.querySelector("#reading-progress-bar");let scrollTop=0;let scrollBottom=0;let scrollPercent=0;var addClassOnScroll=()=>{header.classList.add("shadow");header.classList.add("bg-white-90");}
var removeClassOnScroll=()=>{header.classList.remove("shadow");header.classList.remove("bg-white-90");}
window.onscroll=function(){scrollPos=window.scrollY;scrollTop=document.documentElement["scrollTop"]||document.body["scrollTop"];scrollBottom=(document.documentElement["scrollHeight"]||document.body["scrollHeight"])-document.documentElement.clientHeight;scrollPercent=scrollTop/scrollBottom*100;readingProgressBar.style.width=(scrollTop/scrollBottom*100)+'%';if(scrollPos>0){addClassOnScroll()}
else{removeClassOnScroll()}}}
document.addEventListener('turbolinks:load',initHeader());</script></body></html>