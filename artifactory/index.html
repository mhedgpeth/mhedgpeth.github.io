<!doctype html><html prefix="og: http://ogp.me/ns#" lang=en-us><head itemscope itemtype=https://hedge-ops.com/><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:locale" content="en"><meta name=language content="en"><title itemprop=name>Chef Artifacts with Artifactory &#183; Michael Hedgpeth</title><meta property="og:title" content="Chef Artifacts with Artifactory &#183; Michael Hedgpeth"><meta name=twitter:title content="Chef Artifacts with Artifactory &#183; Michael Hedgpeth"><meta itemprop=name content="Chef Artifacts with Artifactory &#183; Michael Hedgpeth"><meta name=application-name content="Michael Hedgpeth"><meta property="og:site_name" content="Michael Hedgpeth"><base href=https://hedge-ops.com/artifactory/><link rel=canonical href=https://hedge-ops.com/artifactory/ itemprop=url><meta name=url content="https://hedge-ops.com/artifactory/"><meta name=twitter:url content="https://hedge-ops.com/artifactory/"><meta property="og:url" content="https://hedge-ops.com/artifactory/"><meta itemprop=image content="https://hedge-ops.com/images/michael.jpg"><meta property="og:image" content="https://hedge-ops.com/images/michael.jpg"><meta name=twitter:image content="https://hedge-ops.com/images/michael.jpg"><meta name=twitter:image:src content="https://hedge-ops.com/images/michael.jpg"><meta name=twitter:card content="summary_large_image"><meta property="og:type" content="article"><meta itemprop=description content="If you&amp;rsquo;re going to deploy anything, you&amp;rsquo;ll eventually come across a fundamental need: you need somewhere to put your large files. At first, Chef see"><meta property="og:description" content="If you&amp;rsquo;re going to deploy anything, you&amp;rsquo;ll eventually come across a fundamental need: you need somewhere to put your large files. At first, Chef see"><meta name=description content="If you&amp;rsquo;re going to deploy anything, you&amp;rsquo;ll eventually come across a fundamental need: you need somewhere to put your large files. At first, Chef see"><meta name=twitter:description content="If you&amp;rsquo;re going to deploy anything, you&amp;rsquo;ll eventually come across a fundamental need: you need somewhere to put your large files. At first, Chef see"><meta property="article:published_time" content="2017-05-19T00:00:00Z"><meta name=twitter:label1 value="Reading time"><meta name=twitter:data1 value="4 minutes"><meta name=twitter:label2 value=Published><meta name=twitter:data2 value="May 19, 2017"><meta property="article:tag" content="chef"><meta property="og:updated_time" content="2017-05-19T00:00:00Z"><meta property="og:article:author" content="Michael"><meta property="article:author" content="Michael"><meta name=author content="Michael"><meta name=generator content="Hugo 0.72.0"><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com/ crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel=stylesheet><link rel=stylesheet href=https://hedge-ops.com/css/styles.min.ef433e47a104e30937dfad230e28b6dd329c9b4fe18ff4925850da1f24df3133.css integrity="sha256-70M+R6EE4wk3360jDii23TKcm0/hj/SSWFDaHyTfMTM="><link href=/index.xml rel=alternate type=application/rss+xml title="Michael Hedgpeth"><script src=https://cdnjs.cloudflare.com/ajax/libs/turbolinks/5.2.0/turbolinks.js></script></head><body class="bg-gradient flex flex-col min-h-screen"><header id=header class="w-full m-0 fixed z-10 transition-all duration-300 ease-in-out border-t-4 border-gray-300 backdrop-filter-blur"><div id=header-container class="max-w-7xl mx-auto p-6 flex items-center flex-wrap lg:flex-no-wrap relative justify-between"><a href=https://hedge-ops.com/ class="tracking-tighter leading-10 text-3xl font-semibold text-gray-600 flex flex-shrink-0">Michael Hedgpeth</a><div class="block lg:hidden mx-2"><button class="nav-button w-10 h-10 justify-center flex items-center opacity-75 hover:opacity-100 transition duration-300 ease-in-out"><svg class="fill-current h-4 w-4" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"/></svg></button>
<button class="hidden nav-button w-10 h-10 justify-center flex items-center opacity-75 hover:opacity-100 transition duration-300 ease-in-out"><svg class="fill-current h-4 w-4" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Close menu</title><polygon points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2" transform="rotate(45 10 10)"/></svg></button></div><div class="absolute right-8 top-16 lg:relative lg:right-0 lg:top-0 flex flex-col lg:flex-row items-center rounded-md bg-white shadow lg:bg-transparent lg:shadow-none"><nav id=nav-social-links class="p-4 lg:p-0 text-gray-600 hidden lg:block lg:order-last w-full lg:w-auto lg:ml-3"><ul class="flex justify-end"><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Twitter href=https://www.twitter.com/michaelhedgpeth rel=me><svg class="fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Twitter</title><path d="M6.29 18.25c7.55.0 11.67-6.25 11.67-11.67v-.53c.8-.59 1.49-1.3 2.04-2.13-.75.33-1.54.55-2.36.65a4.12 4.12.0 001.8-2.27c-.8.48-1.68.81-2.6 1a4.1 4.1.0 00-7 3.74 11.65 11.65.0 01-8.45-4.3 4.1 4.1.0 001.27 5.49C2.01 8.2 1.37 8.03.8 7.7v.05a4.1 4.1.0 003.3 4.03 4.1 4.1.0 01-1.86.07 4.1 4.1.0 003.83 2.85A8.23 8.23.0 010 16.4a11.62 11.62.0 006.29 1.84"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Github href=https://www.github.com/mhedgpeth rel=me><svg class="fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>GitHub</title><path d="M10 0A10 10 0 006.84 19.49c.5.1.68-.22.68-.48l-.01-1.7c-2.78.6-3.37-1.34-3.37-1.34-.46-1.16-1.11-1.47-1.11-1.47-.9-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.9 1.52 2.34 1.08 2.91.83.1-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.94.0-1.1.39-1.99 1.03-2.69a3.6 3.6.0 01.1-2.64s.84-.27 2.75 1.02a9.58 9.58.0 015 0c1.91-1.3 2.75-1.02 2.75-1.02.55 1.37.2 2.4.1 2.64.64.7 1.03 1.6 1.03 2.69.0 3.84-2.34 4.68-4.57 4.93.36.31.68.92.68 1.85l-.01 2.75c0 .26.18.58.69.48A10 10 0 0010 0"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Linkedin href=https://linkedin.com/in/michael-hedgpeth rel=me><svg class="fill-current w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Feed href=/index.xml><svg class="fill-current w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>RSS</title><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg></a></li></ul></nav><nav id=nav-menu class="p-4 lg:p-0 hidden lg:block w-full lg:w-auto text-gray-600"><ul class="w-full flex flex-col lg:flex-row justify-end items-end lg:items-center"><li class="flex my-2 lg:my-2 mx-1 lg:mx-2"><a title=About class="uppercase font-bold lg:py-2 lg:px-3 rounded text-sm opacity-75 hover:opacity-100 transition duration-300 ease-in-out" href=/about>About</a></li><li class="flex my-2 lg:my-2 mx-1 lg:mx-2"><a title=Speaking class="uppercase font-bold lg:py-2 lg:px-3 rounded text-sm opacity-75 hover:opacity-100 transition duration-300 ease-in-out" href=/speaking>Speaking</a></li></ul></nav></div></div></header><main class="flex-1 mt-12 max-w-3xl mt-32 mx-auto text-gray-700 w-full"><div id=reading-progress-bar role=presentation class="fixed z-10 top-0 left-0 h-1 bg-gray-700"></div><article class=article><header class="text-center pt-10 pb-6"><small class="text-center text-sm"><time class=text-gray-500 datetime=2017-05-19T00:00:00+00:00>May 19, 2017</time>
<a href=https://hedge-ops.com/tags/chef/ class="inline-flex items-center px-4 py-1 rounded-full no-underline bg-orange-100 text-orange-800 hover:bg-orange-300 ml-4">chef</a></small><h1 class="leading-9 text-center"><a href=https://hedge-ops.com/artifactory/ class="no-underline inline-block text-black relative"><div class=dots aria-hidden=true></div>Chef Artifacts with Artifactory</a></h1></header><div class=article__content><div class=full-width><img src=/images/feature-artifactory.jpg alt=Artifactory></div><p>If you&rsquo;re going to deploy anything, you&rsquo;ll eventually come across a fundamental need: you need somewhere to put your large files. At first, Chef seems like an attractive choice for this, but on deeper inspection it&rsquo;s a horrible path to take. Chef is really great at delivering idempotent scripts to your machines to test and repair. It&rsquo;s not that great of a file server. Storing your files in Chef will make your cookbooks more bloated, your source code repositories more bloated, and cause pain all around.</p><p>So it&rsquo;s been a pleasure recently to discover how great artifactory is for a tool for managing artifacts for deployments. Artifactory very naturally and easily lets you get up and running with hosting artifacts in a safe and scalable way. I&rsquo;d like to lay out a bit of how we use artifactory for those interested in using it for themselves.</p><h2 id=licensing>Licensing</h2><p>First, I <em>really</em> want to give artifactory my money, but there is a budget cycle to fend with, and besides people don&rsquo;t want to spend money unless they can see the value they&rsquo;re getting. So this post will be based on the <em>free</em> version of artifactory. Fortunately, the free version contains what we need; we just need to host artifacts and call it good. Later we can get into the fancypants gem repos, supermarket, artifact expiration features. For now let&rsquo;s ship it!</p><h2 id=installation>Installation</h2><p>It was quite delightful for me to get artifactory up and running. In evaluation mode I did this with docker:</p><h3 id=docker>Docker</h3><p>I first just pull the image:</p><pre><code>docker pull docker.bintray.io/jfrog/artifactory-oss:latest
</code></pre><p>And then run the container:</p><pre><code>docker run --name artifactory -d -p 8081:8081 docker.bintray.io/jfrog/artifactory-oss:latest
</code></pre><p>I then navigate my browser to <code>http://localhost:8081</code> and I&rsquo;m immediately using artifactory. This was an excellent example of <a href=http://www.anniehedgie.com/docker>inverted learning</a> that Annie loves to talk about.</p><h3 id=package-installation>Package Installation</h3><p>For those of us freaked out about running Docker in production, artifactory&rsquo;s package installation is pretty good as well:</p><pre><code>wget https://bintray.com/jfrog/artifactory-rpms/rpm -O bintray-jfrog-artifactory-rpms.repo
sudo mv bintray-jfrog-artifactory-rpms.repo /etc/yum.repos.d/
sudo yum install jfrog-artifactory-oss
</code></pre><p>It&rsquo;s really that easy. They did a fantastic job of making it easy.</p><h2 id=uploading>Uploading</h2><p>Creating and uploading artifacts with artifactory is easy to intuit on their web UI. For CI jobs, we&rsquo;ve found that the <a href=https://www.jfrog.com/confluence/display/CLI/JFrog+CLI><code>jfrog.exe</code></a> is a really nice way of making uploads easy.</p><p>This way <a href=https://www.jfrog.com/confluence/display/CLI/CLI+for+JFrog+Artifactory#CLIforJFrogArtifactory-Configuration>you can store your authentication credentials</a> for uploading to artifactory on your build agents in a <code>~/.jfrog/jfrog-cli.conf</code> file. This way your usage of the <code>jfrog.exe</code> can be very simple:</p><p>You can <a href=https://www.jfrog.com/confluence/display/CLI/CLI+for+JFrog+Artifactory#CLIforJFrogArtifactory-UploadingFiles>upload</a>:</p><pre><code>jfrog rt u *.tgz product-repo/policyfile-archives
</code></pre><p>And you can <a href=https://www.jfrog.com/confluence/display/CLI/CLI+for+JFrog+Artifactory#CLIforJFrogArtifactory-DownloadingFiles>download</a></p><pre><code>jfrog rt dl product-repo/policyfile-archives/webserver-3498732hjfkdlsfdahlfewlrhewkl.tgz
</code></pre><p>If you&rsquo;re doing it right, that&rsquo;s about all that you need.</p><h2 id=access-control>Access Control</h2><p>For any automation situation, you want to create access control to the assets of that automation. That way you prevent, at many levels, the situation where your scripts accidentally deploy the same product on all your nodes. If you keep access restricted, you keep things happening the way you&rsquo;d say they would happen.</p><p>Fortunately, artifactory allows for <a href=https://www.jfrog.com/confluence/display/RTF/Managing+Users>users to be created</a> for this very purpose. So each of your products could have its own artifactory user, which would only be granted access to the repositories you say it should.</p><h2 id=chef-integration>Chef Integration</h2><p>Fortunately, artifactory provides an http api that works very nicely with the <code>remote_file</code> resource:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>remote_file <span style=color:#d14>&#39;C:\cafe\staging\chef-client-13.0.118-1-x64.msi&#39;</span> <span style=color:#000;font-weight:700>do</span>
  source <span style=color:#d14>&#39;https://productuser:mypassw0rd@artifactory.mycompany.com/artifactory/chef-repo/chef-client-13.0.118-1-x64.msi&#39;</span>
  checksum <span style=color:#d14>&#39;c594965648e20a2339d6f33d236b4e3e22b2be6916cceb1b0f338c74378c03da&#39;</span>
<span style=color:#000;font-weight:700>end</span>
</code></pre></div><p>You can <a href=https://coderanger.net/chef-tips/#3>create a module</a> that will build your url for you and make it even easier:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>remote_file <span style=color:#d14>&#39;C:\cafe\staging\chef-client-13.0.118-1-x64.msi&#39;</span> <span style=color:#000;font-weight:700>do</span>
  extends <span style=color:#000;font-weight:700>::</span><span style=color:teal>Artifactory</span><span style=color:#000;font-weight:700>::</span><span style=color:teal>UrlResolver</span>
  source artifactory_url <span style=color:#d14>&#39;chef-repo/chef-client-13.0.118-1-x64.msi&#39;</span>
  checksum <span style=color:#d14>&#39;c594965648e20a2339d6f33d236b4e3e22b2be6916cceb1b0f338c74378c03da&#39;</span>
<span style=color:#000;font-weight:700>end</span>
</code></pre></div><p>Having an https url is great because I can use a lot of third party chef cookbooks that just need a URL.</p><p>We have even taken it a step further and developed our own custom resource:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>artifactory_file <span style=color:#d14>&#39;C:\cafe\staging\chef-client-13.0.118-1-x64.msi&#39;</span> <span style=color:#000;font-weight:700>do</span>
  repsoitory_path <span style=color:#d14>&#39;chef-repo/chef-client-13.0.118-1-x64.msi&#39;</span>
  checksum <span style=color:#d14>&#39;c594965648e20a2339d6f33d236b4e3e22b2be6916cceb1b0f338c74378c03da&#39;</span>
<span style=color:#000;font-weight:700>end</span>
</code></pre></div><p>This will automatically determine the artifactory path we use to all of our cookbooks that just want to download a file can be easier to code.</p><h2 id=checksum-validation>Checksum Validation</h2><p>You should be checking checksums on all downloads. Fortunately the <code>remote_file</code> resource gives you a built-in way to do this. Simply add the <code>checksum</code> attribute to your resource and you have checking. That way if your files are tampered with or not what you expected, you don&rsquo;t go ahead; you stop right there. That&rsquo;s the &ldquo;limit the damage when things go wrong&rdquo; principle at work again. This is something I learned well from my security friends.</p><h2 id=conclusion>Conclusion</h2><p>Artifactory is a fantastic an essential ally to Chef in your search for DevOps nirvana. I highly recommend it over the other alternatives: Nexus by Sonatype and your own SFTP server. We&rsquo;re extremely happy with this product.</p></div><section class="my-5 pt-10 pb-5 border-t border-gray-400 flex items-center"><img alt="Avatar photo" class="border border-gray-400 p-1 w-10 h-10 rounded-full mr-3" src=/images/michael.jpg>
<span class=flex-grow>Michael Hedgpeth</span>
<a href="http://twitter.com/share?url=https%3a%2f%2fhedge-ops.com%2fartifactory%2f&text=Chef%20Artifacts%20with%20Artifactory&via=michaelhedgpeth" class="text-white text-xs font-bold rounded-md no-underline flex items-center px-3 py-2 bg-twitter hover:color-white hover:opacity-75 no-underline"><svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Twitter</title><path d="M6.29 18.25c7.55.0 11.67-6.25 11.67-11.67v-.53c.8-.59 1.49-1.3 2.04-2.13-.75.33-1.54.55-2.36.65a4.12 4.12.0 001.8-2.27c-.8.48-1.68.81-2.6 1a4.1 4.1.0 00-7 3.74 11.65 11.65.0 01-8.45-4.3 4.1 4.1.0 001.27 5.49C2.01 8.2 1.37 8.03.8 7.7v.05a4.1 4.1.0 003.3 4.03 4.1 4.1.0 01-1.86.07 4.1 4.1.0 003.83 2.85A8.23 8.23.0 010 16.4a11.62 11.62.0 006.29 1.84"/></svg>Tweet</a></section><section class="my-5 py-5 relative"><h2>Interactions</h2></section></article><aside class=flex><a class="w-full md:w-1/2 flex flex-col items-center py-7 px-3 no-underline rounded-md hover:bg-white transition duration-300 ease-in-out" href=/chef-community/><span class="border border-gray-6 text-xs rounded-md mb-2 uppercase font-bold py-2 px-3">Read this next</span>
<span class=text-center>Chef is a Community Before It's a Vendor</span></a>
<a class="w-full md:w-1/2 flex flex-col items-center py-7 px-3 no-underline rounded-md hover:bg-white transition duration-300 ease-in-out" href=/chef-rollback/><span class="border border-gray-6 text-xs rounded-md mb-2 uppercase font-bold py-2 px-3">You might enjoy</span>
<span class=text-center>Chef Rollback with Policyfiles and Cafe</span></a></aside></main><footer class="w-full max-w-7xl mx-auto text-center border-t border-gray-200 py-9 px-3 mt-9 pin-b text-sm text-gray-500">Made with <a href=https://gohugo.io class="underline transition duration-300 ease-in-out hover:text-blue-600">Hugo</a> and <a href=https://github.com/leonardofaria/bento class="underline transition duration-300 ease-in-out hover:text-blue-600">Bento theme</a>.
Copyright © 2020 Michael Hedgpeth</footer><script>var initMenu=()=>{var navButtons=document.querySelectorAll('.nav-button');var navMenu=document.querySelector('#nav-menu');var navSocialLinks=document.querySelector('#nav-social-links');for(var button of navButtons){button.addEventListener('click',()=>{console.log('click')
navMenu.classList.toggle("hidden");if(navSocialLinks){navSocialLinks.classList.toggle("hidden");}
for(var navButton of navButtons){navButton.classList.toggle("hidden");};});}}
document.addEventListener('turbolinks:load',initMenu());</script><script>var initHeader=()=>{let scrollPos=window.scrollY;var header=document.querySelector('#header');var headerContainer=document.querySelector("#header-container");var readingProgressBar=document.querySelector("#reading-progress-bar");let scrollTop=0;let scrollBottom=0;let scrollPercent=0;var addClassOnScroll=()=>{header.classList.add("shadow");header.classList.add("bg-white-90");}
var removeClassOnScroll=()=>{header.classList.remove("shadow");header.classList.remove("bg-white-90");}
window.onscroll=function(){scrollPos=window.scrollY;scrollTop=document.documentElement["scrollTop"]||document.body["scrollTop"];scrollBottom=(document.documentElement["scrollHeight"]||document.body["scrollHeight"])-document.documentElement.clientHeight;scrollPercent=scrollTop/scrollBottom*100;readingProgressBar.style.width=(scrollTop/scrollBottom*100)+'%';if(scrollPos>0){addClassOnScroll()}
else{removeClassOnScroll()}}}
document.addEventListener('turbolinks:load',initHeader());</script></body></html>