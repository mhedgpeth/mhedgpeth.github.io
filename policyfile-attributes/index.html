<!doctype html><html prefix="og: http://ogp.me/ns#" lang=en-us><head itemscope itemtype=https://hedge-ops.com/><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:locale" content="en"><meta name=language content="en"><title itemprop=name>Policyfile Attributes &#183; Michael Hedgpeth</title><meta property="og:title" content="Policyfile Attributes &#183; Michael Hedgpeth"><meta name=twitter:title content="Policyfile Attributes &#183; Michael Hedgpeth"><meta itemprop=name content="Policyfile Attributes &#183; Michael Hedgpeth"><meta name=application-name content="Michael Hedgpeth"><meta property="og:site_name" content="Michael Hedgpeth"><base href=https://hedge-ops.com/policyfile-attributes/><link rel=canonical href=https://hedge-ops.com/policyfile-attributes/ itemprop=url><meta name=url content="https://hedge-ops.com/policyfile-attributes/"><meta name=twitter:url content="https://hedge-ops.com/policyfile-attributes/"><meta property="og:url" content="https://hedge-ops.com/policyfile-attributes/"><meta itemprop=image content="https://hedge-ops.com/images/michael.jpg"><meta property="og:image" content="https://hedge-ops.com/images/michael.jpg"><meta name=twitter:image content="https://hedge-ops.com/images/michael.jpg"><meta name=twitter:image:src content="https://hedge-ops.com/images/michael.jpg"><meta name=twitter:card content="summary_large_image"><meta property="og:type" content="article"><meta itemprop=description content="When you start with policyfiles you quickly fall in love with the simplicity of the workflow and how easy it is to learn and teach. However, you&amp;rsquo;re also f"><meta property="og:description" content="When you start with policyfiles you quickly fall in love with the simplicity of the workflow and how easy it is to learn and teach. However, you&amp;rsquo;re also f"><meta name=description content="When you start with policyfiles you quickly fall in love with the simplicity of the workflow and how easy it is to learn and teach. However, you&amp;rsquo;re also f"><meta name=twitter:description content="When you start with policyfiles you quickly fall in love with the simplicity of the workflow and how easy it is to learn and teach. However, you&amp;rsquo;re also f"><meta property="article:published_time" content="2016-11-14T08:00:00Z"><meta name=twitter:label1 value="Reading time"><meta name=twitter:data1 value="8 minutes"><meta name=twitter:label2 value=Published><meta name=twitter:data2 value="November 14, 2016"><meta property="article:tag" content="chef"><meta property="og:updated_time" content="2016-11-14T08:00:00Z"><meta property="og:article:author" content="Michael"><meta property="article:author" content="Michael"><meta name=author content="Michael"><meta name=generator content="Hugo 0.72.0"><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com/ crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel=stylesheet><link rel=stylesheet href=https://hedge-ops.com/css/styles.min.ef433e47a104e30937dfad230e28b6dd329c9b4fe18ff4925850da1f24df3133.css integrity="sha256-70M+R6EE4wk3360jDii23TKcm0/hj/SSWFDaHyTfMTM="><link href=/index.xml rel=alternate type=application/rss+xml title="Michael Hedgpeth"><script src=https://cdnjs.cloudflare.com/ajax/libs/turbolinks/5.2.0/turbolinks.js></script></head><body class="bg-gradient flex flex-col min-h-screen"><header id=header class="w-full m-0 fixed z-10 transition-all duration-300 ease-in-out border-t-4 border-gray-300 backdrop-filter-blur"><div id=header-container class="max-w-7xl mx-auto p-6 flex items-center flex-wrap lg:flex-no-wrap relative justify-between"><a href=https://hedge-ops.com/ class="tracking-tighter leading-10 text-3xl font-semibold text-gray-600 flex flex-shrink-0">Michael Hedgpeth</a><div class="block lg:hidden mx-2"><button class="nav-button w-10 h-10 justify-center flex items-center opacity-75 hover:opacity-100 transition duration-300 ease-in-out"><svg class="fill-current h-4 w-4" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"/></svg></button>
<button class="hidden nav-button w-10 h-10 justify-center flex items-center opacity-75 hover:opacity-100 transition duration-300 ease-in-out"><svg class="fill-current h-4 w-4" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Close menu</title><polygon points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2" transform="rotate(45 10 10)"/></svg></button></div><div class="absolute right-8 top-16 lg:relative lg:right-0 lg:top-0 flex flex-col lg:flex-row items-center rounded-md bg-white shadow lg:bg-transparent lg:shadow-none"><nav id=nav-social-links class="p-4 lg:p-0 text-gray-600 hidden lg:block lg:order-last w-full lg:w-auto lg:ml-3"><ul class="flex justify-end"><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Twitter href=https://www.twitter.com/michaelhedgpeth rel=me><svg class="fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Twitter</title><path d="M6.29 18.25c7.55.0 11.67-6.25 11.67-11.67v-.53c.8-.59 1.49-1.3 2.04-2.13-.75.33-1.54.55-2.36.65a4.12 4.12.0 001.8-2.27c-.8.48-1.68.81-2.6 1a4.1 4.1.0 00-7 3.74 11.65 11.65.0 01-8.45-4.3 4.1 4.1.0 001.27 5.49C2.01 8.2 1.37 8.03.8 7.7v.05a4.1 4.1.0 003.3 4.03 4.1 4.1.0 01-1.86.07 4.1 4.1.0 003.83 2.85A8.23 8.23.0 010 16.4a11.62 11.62.0 006.29 1.84"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Github href=https://www.github.com/mhedgpeth rel=me><svg class="fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>GitHub</title><path d="M10 0A10 10 0 006.84 19.49c.5.1.68-.22.68-.48l-.01-1.7c-2.78.6-3.37-1.34-3.37-1.34-.46-1.16-1.11-1.47-1.11-1.47-.9-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.9 1.52 2.34 1.08 2.91.83.1-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.94.0-1.1.39-1.99 1.03-2.69a3.6 3.6.0 01.1-2.64s.84-.27 2.75 1.02a9.58 9.58.0 015 0c1.91-1.3 2.75-1.02 2.75-1.02.55 1.37.2 2.4.1 2.64.64.7 1.03 1.6 1.03 2.69.0 3.84-2.34 4.68-4.57 4.93.36.31.68.92.68 1.85l-.01 2.75c0 .26.18.58.69.48A10 10 0 0010 0"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Linkedin href=https://linkedin.com/in/michael-hedgpeth rel=me><svg class="fill-current w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Feed href=/index.xml><svg class="fill-current w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>RSS</title><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg></a></li></ul></nav><nav id=nav-menu class="p-4 lg:p-0 hidden lg:block w-full lg:w-auto text-gray-600"><ul class="w-full flex flex-col lg:flex-row justify-end items-end lg:items-center"><li class="flex my-2 lg:my-2 mx-1 lg:mx-2"><a title=About class="uppercase font-bold lg:py-2 lg:px-3 rounded text-sm opacity-75 hover:opacity-100 transition duration-300 ease-in-out" href=/about>About</a></li><li class="flex my-2 lg:my-2 mx-1 lg:mx-2"><a title=Speaking class="uppercase font-bold lg:py-2 lg:px-3 rounded text-sm opacity-75 hover:opacity-100 transition duration-300 ease-in-out" href=/speaking>Speaking</a></li></ul></nav></div></div></header><main class="flex-1 mt-12 max-w-3xl mt-32 mx-auto text-gray-700 w-full"><div id=reading-progress-bar role=presentation class="fixed z-10 top-0 left-0 h-1 bg-gray-700"></div><article class=article><header class="text-center pt-10 pb-6"><small class="text-center text-sm"><time class=text-gray-500 datetime=2016-11-14T08:00:00+00:00>November 14, 2016</time>
<a href=https://hedge-ops.com/tags/chef/ class="inline-flex items-center px-4 py-1 rounded-full no-underline bg-orange-100 text-orange-800 hover:bg-orange-300 ml-4">chef</a></small><h1 class="leading-9 text-center"><a href=https://hedge-ops.com/policyfile-attributes/ class="no-underline inline-block text-black relative"><div class=dots aria-hidden=true></div>Policyfile Attributes</a></h1></header><div class=article__content><div class=full-width><img src=/images/feature-policyfile-attributes.jpg alt="Policyfile Attributes"></div><p>When you start with <a href=/policyfiles/>policyfiles</a> you quickly fall in love with the simplicity of the workflow and how easy it is to learn and teach. However, you&rsquo;re also faced with an apparent show-stopper to adoption: there are lots of community cookbooks out there that expect certain attributes to be in certain locations. It can be quite confusing; I&rsquo;m sure it&rsquo;s kept a lot of people from adopting the feature. So let&rsquo;s get that one out of the way in this post.</p><p>We&rsquo;ll take the use cases from easiest to most difficult:</p><h1 id=define-attributes-within-policyfile>Define Attributes within Policyfile</h1><p>Many times you&rsquo;ll come across a community cookbook that expects attributes to be defined for it to properly run, like with the <code>apache</code> cookbook.</p><p>If the behavior of your cookbook doesn&rsquo;t change very often, you can declare those attributes in your <code>Policyfile.rb</code> if you want to:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#998;font-style:italic># in Policyfile.rb</span>
default<span style=color:#000;font-weight:700>[</span><span style=color:#d14>&#39;apache2&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span> {
    <span style=color:#990073>listen_ports</span>: <span style=color:#000;font-weight:700>[</span><span style=color:#d14>&#39;80&#39;</span>, <span style=color:#d14>&#39;443&#39;</span><span style=color:#000;font-weight:700>]</span>
}
</code></pre></div><p>That will get you by for simple situations, but if you&rsquo;re dealing with a half a dozen or more policies that use this cookbook, this will get very repetitive, and therefore error prone. My rule is if you repeat yourself more than three times then <a href=https://en.wikipedia.org/wiki/Don%27t_repeat_yourself>you need to do something about it</a>.</p><h1 id=define-attributes-within-wrapper-cookbook>Define Attributes within Wrapper Cookbook</h1><p>In this case, I would create a wrapper cookbook called <code>mycompany-apache</code> and define the attributes there. Then I can use that recipe in my runlist for all of my policies.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#998;font-style:italic># in mycompany-apache/attributes/default.rb</span>
default<span style=color:#000;font-weight:700>[</span><span style=color:#d14>&#39;apache2&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span> {
    <span style=color:#990073>listen_ports</span>: <span style=color:#000;font-weight:700>[</span><span style=color:#d14>&#39;80&#39;</span>, <span style=color:#d14>&#39;443&#39;</span><span style=color:#000;font-weight:700>]</span>
}
</code></pre></div><p>In fact, as a rule of thumb I generally try to keep attributes out of my policyfiles. It&rsquo;s great for smaller cases, and if you just have a few and are getting started, by all means do it, but it creates an unmaintainable mess if you have a lot of machines that need to run against the same attributes.</p><p>As time has gone on, I think of Policyfiles as defining <em>what</em> chef scripts should run on a node and something else to handle the configuration elements that those scripts need.</p><h1 id=define-environment-specific-attributes-in-the-policyfile>Define Environment-specific Attributes in the Policyfile</h1><p>With most if not all attributes now removed from my policyfiles, I come across a good reason to include them again: I need to have environment-specific settings that my cookbooks use. For example, let&rsquo;s say that I need to use <code>testdatabase</code> for my <code>qa</code> environment and <code>proddatabase</code> for my <code>production</code> environment.</p><p>You can do this pretty easily with Policyfiles:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#998;font-style:italic># in Policyfile.rb</span>
default<span style=color:#000;font-weight:700>[</span><span style=color:#d14>&#39;qa&#39;</span><span style=color:#000;font-weight:700>][</span><span style=color:#d14>&#39;myapplication&#39;</span><span style=color:#000;font-weight:700>][</span><span style=color:#d14>&#39;database&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;testdatabase&#39;</span>
default<span style=color:#000;font-weight:700>[</span><span style=color:#d14>&#39;production&#39;</span><span style=color:#000;font-weight:700>][</span><span style=color:#d14>&#39;myapplication&#39;</span><span style=color:#000;font-weight:700>][</span><span style=color:#d14>&#39;database&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;productiondatabase&#39;</span>
</code></pre></div><p>Now in my recipe code I can simply write:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#998;font-style:italic># in recipes/default.rb</span>
database <span style=color:#000;font-weight:700>=</span> node<span style=color:#000;font-weight:700>[</span><span style=color:teal>Chef</span><span style=color:#000;font-weight:700>::</span><span style=color:teal>Config</span><span style=color:#000;font-weight:700>.</span>policy_group<span style=color:#000;font-weight:700>][</span><span style=color:#d14>&#39;myapplication&#39;</span><span style=color:#000;font-weight:700>][</span><span style=color:#d14>&#39;database&#39;</span><span style=color:#000;font-weight:700>]</span>
</code></pre></div><p>This is, frankly, how most of our applications work with Policyfiles. This has been good enough for us and therefore is what we went for. Since then, we&rsquo;ve come across other use cases which cause us to go further:</p><h1 id=define-environment-specfic-attributes-in-the-policyfile-consume-them-as-normal-attributes>Define Environment-specfic Attributes in the Policyfile, Consume Them As Normal Attributes</h1><p>One of the major drawbacks of the previous section is the need to change your code to deal with the <code>policy_group</code> within the hash to get to your value. This is fine if you&rsquo;re starting from scratch like I did, but that won&rsquo;t work for everyone. Thankfully <a href=https://coderanger.net/>code ranger</a> and friends created the <a href=https://github.com/poise/poise-hoist>poise-hoist</a> cookbook, which handles a lot of the translation for you.</p><p>In order to do this, just add <code>poise_hoist</code> to the <code>run_list</code> of your <code>Policyfile.rb</code>.</p><p>Then, assuming you have the structure from the previous section, you&rsquo;ll be able to get the database without using the <code>policy_group</code>:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#998;font-style:italic># in recipes/default.rb, now using poise_hoist</span>
database <span style=color:#000;font-weight:700>=</span> node<span style=color:#000;font-weight:700>[</span><span style=color:#d14>&#39;myapplication&#39;</span><span style=color:#000;font-weight:700>][</span><span style=color:#d14>&#39;database&#39;</span><span style=color:#000;font-weight:700>]</span>
</code></pre></div><p>If you were using environments before and that kept you from using Policyfiles, <strong>you now no longer have any excuse.</strong> Yes, that&rsquo;s right: <strong>you can use Policyfiles without changing a line of code by using the <code>poise_hoist</code> cookbook!</strong></p><h1 id=define-role-specific-attributes-in-the-policyfile-consume-them-as-normal-attributes>Define Role-specific Attributes in the Policyfile, Consume Them As Normal Attributes</h1><p>The same workflow we used above to migrate from environments can be used with our roles as well.</p><p>We should first understand that roles don&rsquo;t exist within policyfiles. To accomplish the same end, we use a wrapper cookbook that encapsulates everything we want that role to do.</p><p>For example you could have a base role that you want everything to follow by creating a <code>mycompany-platform</code> cookbook. Its default recipe could be something like this:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#998;font-style:italic># in mycompany-platform/recipes/default.rb</span>
include_recipe <span style=color:#d14>&#39;logging_provider::default&#39;</span>
include_recipe <span style=color:#d14>&#39;chef-client::default&#39;</span>
</code></pre></div><p>In that same cookbook you could also define attributes that control your cookbooks:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#998;font-style:italic># in mycompany-platform/attributes/default.rb</span>
default<span style=color:#000;font-weight:700>[</span><span style=color:#d14>&#39;chef-client&#39;</span><span style=color:#000;font-weight:700>][</span><span style=color:#d14>&#39;interval&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#099>3600</span>
default<span style=color:#000;font-weight:700>[</span><span style=color:#d14>&#39;logging_provider&#39;</span><span style=color:#000;font-weight:700>][</span><span style=color:#d14>&#39;url&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;http://insanely-expensive.io&#39;</span>
</code></pre></div><p>If you have some elements that change by environment, use the techniques above to do that: <code>poise-hoist</code> will merge those elements into the places that your recipes will expect to look. For example, for the above section of code, if you wanted to make it environment specific, you would write:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#998;font-style:italic># in Policyfile.rb</span>
default<span style=color:#000;font-weight:700>[</span><span style=color:#d14>&#39;qa&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span> {
  chef<span style=color:#000;font-weight:700>-</span><span style=color:#990073>client</span>: {
      <span style=color:#990073>interval</span>: <span style=color:#099>900</span>
  }   
  <span style=color:#990073>logging_provider</span>: {
      <span style=color:#990073>url</span>: <span style=color:#d14>&#39;http://test-cheaply.io&#39;</span>
  }
}

default<span style=color:#000;font-weight:700>[</span><span style=color:#d14>&#39;production&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span> {
    chef<span style=color:#000;font-weight:700>-</span><span style=color:#990073>client</span>: {
        <span style=color:#990073>interval</span>: <span style=color:#099>3600</span>
    }
    <span style=color:#990073>logging_provider</span>: {
        <span style=color:#990073>url</span>: <span style=color:#d14>&#39;http://insanely-expensive.io&#39;</span>
    }
}
</code></pre></div><h1 id=support-lots-of-environments-across-lots-of-policyfiles-with-data-bags>Support Lots of Environments Across Lots of Policyfiles with Data Bags</h1><p>The techniques outlined above work well for applications that have a minimal number of roles and environments. For example, we have one application with a web and application tier and three different environments. For that we have our attributes declared in the <code>application-webserver.rb</code> and <code>application-appserver.rb</code> policyfiles and then flow those policyfiles through our pipeline from <code>qa</code> to <code>uat</code> and finally to <code>production</code> policy groups.</p><p>This starts to fall apart when you need a lot of roles (or policyfiles) use environment-specific attributes. At first glance you might be tempted to create new policy groups, like:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#998;font-style:italic># probably not a good idea</span>
default<span style=color:#000;font-weight:700>[</span><span style=color:#d14>&#39;qa&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span> {
    <span style=color:#990073>my_application</span>: {
        <span style=color:#990073>database</span>: <span style=color:#d14>&#39;qaserver&#39;</span>
    }
 }
default<span style=color:#000;font-weight:700>[</span><span style=color:#d14>&#39;michael-performance&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span> {
    <span style=color:#990073>my_application</span>: {
        <span style=color:#990073>database</span>: <span style=color:#d14>&#39;mhperdb&#39;</span>
    }
}
default<span style=color:#000;font-weight:700>[</span><span style=color:#d14>&#39;mary-testing&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span> {
    <span style=color:#990073>my_application</span>: {
        <span style=color:#990073>database</span>: <span style=color:#d14>&#39;marydb&#39;</span>
    }
}
</code></pre></div><p>You&rsquo;ll encounter a huge problem right away in that you have to copy and maintain these complex structures across a lot of policyfiles. That&rsquo;s a recipe for something to go very wrong.</p><p>Instead, we will offload the attributes definitions here to <a href=https://docs.chef.io/data_bags.html>data bags</a>. So we&rsquo;ll have different data bags per environment:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:navy>&#34;filename&#34;</span>: <span style=color:#d14>&#34;environment_michael-performance.json&#34;</span>,
    <span style=color:navy>&#34;my_application&#34;</span>: {
        <span style=color:navy>&#34;database&#34;</span>: <span style=color:#d14>&#34;mhperdb&#34;</span>
    }
}
</code></pre></div><p>In this example, we&rsquo;ll still keep <code>michael-performance</code> as the <code>policy_group</code> for the node, but we&rsquo;ll not define any of the attributes in the Policyfile, but instead define them in the <code>environment_michael-performance</code> data bag.</p><p>Before the application cookbook runs, we can merge what is in the data bag into our node attributes by borrowing what the <a href=https://github.com/poise/poise-hoist/blob/master/lib/poise_hoist.rb#L38>poise-hoist cookbook does</a>:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#998;font-style:italic># I haven&#39;t run this but hopefully you get the idea</span>
environment <span style=color:#000;font-weight:700>=</span> data_bag_item(<span style=color:#d14>&#39;myapplication&#39;</span>, <span style=color:#d14>&#34;environment-</span><span style=color:#d14>#{</span><span style=color:teal>Chef</span><span style=color:#000;font-weight:700>::</span><span style=color:teal>Config</span><span style=color:#000;font-weight:700>.</span>policy_group<span style=color:#d14>}</span><span style=color:#d14>&#34;</span>)
<span style=color:teal>Chef</span><span style=color:#000;font-weight:700>::</span><span style=color:teal>Mixin</span><span style=color:#000;font-weight:700>::</span><span style=color:teal>DeepMerge</span><span style=color:#000;font-weight:700>.</span>hash_only_merge!(node<span style=color:#000;font-weight:700>.</span>role_default, environment)
</code></pre></div><p>This will, as before, make it so you can have Policyfiles and largely the same code as before because you were able to bring the environment data in from another source and merge it.</p><h1 id=multi-dimensional-attributes-with-data-bags-and-policyfiles>Multi-Dimensional Attributes with Data Bags and Policyfiles</h1><p>We have a couple of products that take this even further. You might have two dimensions of settings: in America, you one service and in Europe you use another. This is true for all environments, but the environments have their own distinct settings.</p><p>In this situation you can create two different types of data bags: <code>environment-uat</code> but also a <code>american-services</code> and <code>european-services</code>. Then you could have nodes know which environment they&rsquo;re in and load the appropriate settings.</p><p>You would have a couple of data bags:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:navy>&#34;filename&#34;</span>: <span style=color:#d14>&#34;american-services&#34;</span>,
    <span style=color:navy>&#34;weather&#34;</span>: <span style=color:#d14>&#34;american-weather-services.com&#34;</span>
}
{
    <span style=color:navy>&#34;filename&#34;</span>: <span style=color:#d14>&#34;european-services&#34;</span>,
    <span style=color:navy>&#34;weather&#34;</span>: <span style=color:#d14>&#34;letempsenfrance.fr&#34;</span>    
}
</code></pre></div><p>Then you can merge that in as normal, based on timezone, or whichever element fits your situation:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>service <span style=color:#000;font-weight:700>=</span> <span style=color:teal>Time</span><span style=color:#000;font-weight:700>.</span>now()<span style=color:#000;font-weight:700>.</span>gmt_offset <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#099>0</span> <span style=color:#000;font-weight:700>?</span> <span style=color:#d14>&#39;american&#39;</span> : <span style=color:#d14>&#39;european&#39;</span>
service_settings <span style=color:#000;font-weight:700>=</span> data_bag_item(<span style=color:#d14>&#39;my_application&#39;</span>, <span style=color:#d14>&#34;</span><span style=color:#d14>#{</span>service<span style=color:#d14>}</span><span style=color:#d14>-services&#34;</span>)
<span style=color:teal>Chef</span><span style=color:#000;font-weight:700>::</span><span style=color:teal>Mixin</span><span style=color:#000;font-weight:700>::</span><span style=color:teal>DeepMerge</span><span style=color:#000;font-weight:700>.</span>hash_only_merge!(node<span style=color:#000;font-weight:700>.</span>role_default, service_settings)
</code></pre></div><p>The long term solution for much of this is to define it within a service discovery product like Consul. But that requires learning and adopting another thing, which will probably slow down getting the wins you&rsquo;ll need early on to be successful. Get what you need to get done here, and then adopt other things that work for you one step at a time.</p><h1 id=policyfile-nirvana---infrastructure-versions-decoupled-from-scripts>Policyfile Nirvana - Infrastructure Versions Decoupled from Scripts</h1><p>When we start with policyfiles, as with the first few use cases above, we tend to put a lot of information in the policyfiles themselves. As things get more complicated, we start to shy away from that because it creates maintainability problems. I&rsquo;ve grown in my usage of policyfiles to think of <strong>policyfiles as a mechanism for getting the right versions of the chef recipes on the node to simply run them.</strong> That&rsquo;s where they really shine; they&rsquo;re an excellent dependency management/workflow simplification feature. They&rsquo;re NOT going to shine for the other things.</p><p>So when I have a version of a website change and therefore need for my scripts to change the file they&rsquo;re using to load that website onto a webserver, I shouldn&rsquo;t use the policyfile for that. Instead I can use the <em>same</em> policyfile (or version of scripts) to download and install a <em>new</em> version of my website.</p><p>In this case, I&rsquo;ve probably moved to the data bags based definition of what that website is:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:navy>&#34;filename&#34;</span>: <span style=color:#d14>&#34;environment-qa.json&#34;</span>,
    <span style=color:navy>&#34;website&#34;</span>: {
        <span style=color:navy>&#34;version&#34;</span>: <span style=color:#d14>&#34;1.0.2&#34;</span>
    }
}
</code></pre></div><p>If I&rsquo;m going to upgrade that database, I probably want to just upgrade the data bag. The script remains the same.</p><p>This, to me, is a nirvana situation. I&rsquo;m running stable scripts/recipes in all environments and am changing small elements of how they run to respect what environment they&rsquo;re in. I&rsquo;ve avoided duplication and therefore increased operatability of the solution.</p><p>So, take a lesson from me, if you&rsquo;re dealing with a complex system with a lot of node types, decouple your application version from the scripts that are running. Your CI/CD pipeline will simplify and it will be simpler to know what changed, why, and how it affects your situation.</p><h1 id=conclusion>Conclusion</h1><p>If you follow the techniques outlined above, you&rsquo;ll have no issue with migrating to Policyfiles. You&rsquo;ll need to make sure that there is a solid business case for it. I think you&rsquo;ll find that the return from better change management and easier operatability will more than pay for the costs you&rsquo;ll incur from using the techniques above.</p></div><section class="my-5 pt-10 pb-5 border-t border-gray-400 flex items-center"><img alt="Avatar photo" class="border border-gray-400 p-1 w-10 h-10 rounded-full mr-3" src=/images/michael.jpg>
<span class=flex-grow>Michael Hedgpeth</span>
<a href="http://twitter.com/share?url=https%3a%2f%2fhedge-ops.com%2fpolicyfile-attributes%2f&text=Policyfile%20Attributes&via=michaelhedgpeth" class="text-white text-xs font-bold rounded-md no-underline flex items-center px-3 py-2 bg-twitter hover:color-white hover:opacity-75 no-underline"><svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Twitter</title><path d="M6.29 18.25c7.55.0 11.67-6.25 11.67-11.67v-.53c.8-.59 1.49-1.3 2.04-2.13-.75.33-1.54.55-2.36.65a4.12 4.12.0 001.8-2.27c-.8.48-1.68.81-2.6 1a4.1 4.1.0 00-7 3.74 11.65 11.65.0 01-8.45-4.3 4.1 4.1.0 001.27 5.49C2.01 8.2 1.37 8.03.8 7.7v.05a4.1 4.1.0 003.3 4.03 4.1 4.1.0 01-1.86.07 4.1 4.1.0 003.83 2.85A8.23 8.23.0 010 16.4a11.62 11.62.0 006.29 1.84"/></svg>Tweet</a></section><section class="my-5 py-5 relative"><h2>Interactions</h2></section></article><aside class=flex><a class="w-full md:w-1/2 flex flex-col items-center py-7 px-3 no-underline rounded-md hover:bg-white transition duration-300 ease-in-out" href=/funnel/><span class="border border-gray-6 text-xs rounded-md mb-2 uppercase font-bold py-2 px-3">Read this next</span>
<span class=text-center>Funnel</span></a>
<a class="w-full md:w-1/2 flex flex-col items-center py-7 px-3 no-underline rounded-md hover:bg-white transition duration-300 ease-in-out" href=/policyfiles/><span class="border border-gray-6 text-xs rounded-md mb-2 uppercase font-bold py-2 px-3">You might enjoy</span>
<span class=text-center>Policyfiles</span></a></aside></main><footer class="w-full max-w-7xl mx-auto text-center border-t border-gray-200 py-9 px-3 mt-9 pin-b text-sm text-gray-500">Made with <a href=https://gohugo.io class="underline transition duration-300 ease-in-out hover:text-blue-600">Hugo</a> and <a href=https://github.com/leonardofaria/bento class="underline transition duration-300 ease-in-out hover:text-blue-600">Bento theme</a>.
Copyright © 2020 Michael Hedgpeth</footer><script>var initMenu=()=>{var navButtons=document.querySelectorAll('.nav-button');var navMenu=document.querySelector('#nav-menu');var navSocialLinks=document.querySelector('#nav-social-links');for(var button of navButtons){button.addEventListener('click',()=>{console.log('click')
navMenu.classList.toggle("hidden");if(navSocialLinks){navSocialLinks.classList.toggle("hidden");}
for(var navButton of navButtons){navButton.classList.toggle("hidden");};});}}
document.addEventListener('turbolinks:load',initMenu());</script><script>var initHeader=()=>{let scrollPos=window.scrollY;var header=document.querySelector('#header');var headerContainer=document.querySelector("#header-container");var readingProgressBar=document.querySelector("#reading-progress-bar");let scrollTop=0;let scrollBottom=0;let scrollPercent=0;var addClassOnScroll=()=>{header.classList.add("shadow");header.classList.add("bg-white-90");}
var removeClassOnScroll=()=>{header.classList.remove("shadow");header.classList.remove("bg-white-90");}
window.onscroll=function(){scrollPos=window.scrollY;scrollTop=document.documentElement["scrollTop"]||document.body["scrollTop"];scrollBottom=(document.documentElement["scrollHeight"]||document.body["scrollHeight"])-document.documentElement.clientHeight;scrollPercent=scrollTop/scrollBottom*100;readingProgressBar.style.width=(scrollTop/scrollBottom*100)+'%';if(scrollPos>0){addClassOnScroll()}
else{removeClassOnScroll()}}}
document.addEventListener('turbolinks:load',initHeader());</script></body></html>