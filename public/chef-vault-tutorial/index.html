<!doctype html><html prefix="og: http://ogp.me/ns#" lang=en-us><head itemscope itemtype=https://hedge-ops.com/><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:locale" content="en"><meta name=language content="en"><title itemprop=name>chef-vault Tutorial &#183; Michael Hedgpeth</title><meta property="og:title" content="chef-vault Tutorial &#183; Michael Hedgpeth"><meta name=twitter:title content="chef-vault Tutorial &#183; Michael Hedgpeth"><meta itemprop=name content="chef-vault Tutorial &#183; Michael Hedgpeth"><meta name=application-name content="Michael Hedgpeth"><meta property="og:site_name" content="Michael Hedgpeth"><base href=https://hedge-ops.com/chef-vault-tutorial/><link rel=canonical href=https://hedge-ops.com/chef-vault-tutorial/ itemprop=url><meta name=url content="https://hedge-ops.com/chef-vault-tutorial/"><meta name=twitter:url content="https://hedge-ops.com/chef-vault-tutorial/"><meta property="og:url" content="https://hedge-ops.com/chef-vault-tutorial/"><meta itemprop=image content="https://hedge-ops.com/images/michael.jpg"><meta property="og:image" content="https://hedge-ops.com/images/michael.jpg"><meta name=twitter:image content="https://hedge-ops.com/images/michael.jpg"><meta name=twitter:image:src content="https://hedge-ops.com/images/michael.jpg"><meta name=twitter:card content="summary_large_image"><meta property="og:type" content="article"><meta itemprop=description content="This week I researched chef-vault and struggled quite a bit with the documentation, so I thought I would write a bit of a tutorial on the technology for those w"><meta property="og:description" content="This week I researched chef-vault and struggled quite a bit with the documentation, so I thought I would write a bit of a tutorial on the technology for those w"><meta name=description content="This week I researched chef-vault and struggled quite a bit with the documentation, so I thought I would write a bit of a tutorial on the technology for those w"><meta name=twitter:description content="This week I researched chef-vault and struggled quite a bit with the documentation, so I thought I would write a bit of a tutorial on the technology for those w"><meta property="article:published_time" content="2016-04-06T00:00:32Z"><meta name=twitter:label1 value="Reading time"><meta name=twitter:data1 value="6 minutes"><meta name=twitter:label2 value=Published><meta name=twitter:data2 value="April 6, 2016"><meta property="article:tag" content="automation"><meta property="article:tag" content="chef"><meta property="article:tag" content="security"><meta property="og:updated_time" content="2016-04-06T00:00:32Z"><meta property="og:article:author" content="Michael"><meta property="article:author" content="Michael"><meta name=author content="Michael"><meta name=generator content="Hugo 0.72.0"><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com/ crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel=stylesheet><link rel=stylesheet href=https://hedge-ops.com/css/styles.min.ef433e47a104e30937dfad230e28b6dd329c9b4fe18ff4925850da1f24df3133.css integrity="sha256-70M+R6EE4wk3360jDii23TKcm0/hj/SSWFDaHyTfMTM="><link href=/index.xml rel=alternate type=application/rss+xml title="Michael Hedgpeth"><script src=https://cdnjs.cloudflare.com/ajax/libs/turbolinks/5.2.0/turbolinks.js></script></head><body class="bg-gradient flex flex-col min-h-screen"><header id=header class="w-full m-0 fixed z-10 transition-all duration-300 ease-in-out border-t-4 border-gray-300 backdrop-filter-blur"><div id=header-container class="max-w-7xl mx-auto p-6 flex items-center flex-wrap lg:flex-no-wrap relative justify-between"><a href=https://hedge-ops.com/ class="tracking-tighter leading-10 text-3xl font-semibold text-gray-600 flex flex-shrink-0">Michael Hedgpeth</a><div class="block lg:hidden mx-2"><button class="nav-button w-10 h-10 justify-center flex items-center opacity-75 hover:opacity-100 transition duration-300 ease-in-out"><svg class="fill-current h-4 w-4" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"/></svg></button>
<button class="hidden nav-button w-10 h-10 justify-center flex items-center opacity-75 hover:opacity-100 transition duration-300 ease-in-out"><svg class="fill-current h-4 w-4" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Close menu</title><polygon points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2" transform="rotate(45 10 10)"/></svg></button></div><div class="absolute right-8 top-16 lg:relative lg:right-0 lg:top-0 flex flex-col lg:flex-row items-center rounded-md bg-white shadow lg:bg-transparent lg:shadow-none"><nav id=nav-social-links class="p-4 lg:p-0 text-gray-600 hidden lg:block lg:order-last w-full lg:w-auto lg:ml-3"><ul class="flex justify-end"><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Twitter href=https://www.twitter.com/michaelhedgpeth rel=me><svg class="fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Twitter</title><path d="M6.29 18.25c7.55.0 11.67-6.25 11.67-11.67v-.53c.8-.59 1.49-1.3 2.04-2.13-.75.33-1.54.55-2.36.65a4.12 4.12.0 001.8-2.27c-.8.48-1.68.81-2.6 1a4.1 4.1.0 00-7 3.74 11.65 11.65.0 01-8.45-4.3 4.1 4.1.0 001.27 5.49C2.01 8.2 1.37 8.03.8 7.7v.05a4.1 4.1.0 003.3 4.03 4.1 4.1.0 01-1.86.07 4.1 4.1.0 003.83 2.85A8.23 8.23.0 010 16.4a11.62 11.62.0 006.29 1.84"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Github href=https://www.github.com/mhedgpeth rel=me><svg class="fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>GitHub</title><path d="M10 0A10 10 0 006.84 19.49c.5.1.68-.22.68-.48l-.01-1.7c-2.78.6-3.37-1.34-3.37-1.34-.46-1.16-1.11-1.47-1.11-1.47-.9-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.9 1.52 2.34 1.08 2.91.83.1-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.94.0-1.1.39-1.99 1.03-2.69a3.6 3.6.0 01.1-2.64s.84-.27 2.75 1.02a9.58 9.58.0 015 0c1.91-1.3 2.75-1.02 2.75-1.02.55 1.37.2 2.4.1 2.64.64.7 1.03 1.6 1.03 2.69.0 3.84-2.34 4.68-4.57 4.93.36.31.68.92.68 1.85l-.01 2.75c0 .26.18.58.69.48A10 10 0 0010 0"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Linkedin href=https://linkedin.com/in/michael-hedgpeth rel=me><svg class="fill-current w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Feed href=/index.xml><svg class="fill-current w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>RSS</title><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg></a></li></ul></nav><nav id=nav-menu class="p-4 lg:p-0 hidden lg:block w-full lg:w-auto text-gray-600"><ul class="w-full flex flex-col lg:flex-row justify-end items-end lg:items-center"><li class="flex my-2 lg:my-2 mx-1 lg:mx-2"><a title=About class="uppercase font-bold lg:py-2 lg:px-3 rounded text-sm opacity-75 hover:opacity-100 transition duration-300 ease-in-out" href=/about>About</a></li><li class="flex my-2 lg:my-2 mx-1 lg:mx-2"><a title=Speaking class="uppercase font-bold lg:py-2 lg:px-3 rounded text-sm opacity-75 hover:opacity-100 transition duration-300 ease-in-out" href=/speaking>Speaking</a></li></ul></nav></div></div></header><main class="flex-1 mt-12 max-w-3xl mt-32 mx-auto text-gray-700 w-full"><div id=reading-progress-bar role=presentation class="fixed z-10 top-0 left-0 h-1 bg-gray-700"></div><article class=article><header class="text-center pt-10 pb-6"><small class="text-center text-sm"><time class=text-gray-500 datetime=2016-04-06T00:00:32+00:00>April 6, 2016</time>
<a href=https://hedge-ops.com/tags/chef/ class="inline-flex items-center px-4 py-1 rounded-full no-underline bg-orange-100 text-orange-800 hover:bg-orange-300 ml-4">chef</a>
<a href=https://hedge-ops.com/tags/automation/ class="inline-flex items-center px-4 py-1 rounded-full no-underline bg-orange-100 text-orange-800 hover:bg-orange-300 ml-4">automation</a>
<a href=https://hedge-ops.com/tags/security/ class="inline-flex items-center px-4 py-1 rounded-full no-underline bg-orange-100 text-orange-800 hover:bg-orange-300 ml-4">Security</a></small><h1 class="leading-9 text-center"><a href=https://hedge-ops.com/chef-vault-tutorial/ class="no-underline inline-block text-black relative"><div class=dots aria-hidden=true></div>chef-vault Tutorial</a></h1></header><div class=article__content><div class=full-width><img src=/images/feature-chef-vault-tutorial.jpg alt="Vault Tutorial"></div><p>This week I researched <a href=https://github.com/chef/chef-vault>chef-vault</a> and struggled quite a bit <a href=https://docs.chef.io/chef_vault.html>with the documentation</a>, so I thought I would write a bit of a tutorial on the technology for those who are interested in quickly understanding how it might work for their organizations.</p><h2 id=why-chef-vault>Why chef-vault?</h2><p><a href=https://docs.chef.io/data_bags.html#encrypt-a-data-bag-item>Encrypted data bags</a> force you to copy the shared secret that is used for decryption to your infrastructure. It&rsquo;s very easy to take that secret file and nefariously decrypt the data from somewhere else without anyone knowing about it. Chef-vault makes this much more difficult by giving both nodes and chef server users expressed permission to decrypt certain data. With chef-vault you don&rsquo;t have to share a secret file with all of your nodes. This is a step up that simplifies everything.</p><p>The solution isn&rsquo;t without its drawbacks. The main one is if you add nodes, you have to rerun something on the server to get that node to be able to decrypt the data bag. With <a href=https://www.hashicorp.com/blog/vault.html>Hashicorp&rsquo;s vault</a> you get better control over that, and better lease management, and credentials creation. To me, encrypted data bags are an unreliable used car, chef-vault is a nice mid-size sedan, and Hashicorp&rsquo;s vault is like a luxury car.</p><p>So now that we know where the tool sits within our choices, let&rsquo;s look at the basics:</p><h2 id=setup>Setup</h2><p>To get started with chef-vault, have the latest <a href=https://downloads.chef.io/chef-dk/>ChefDK</a> installed (0.12 or greater) and install the <a href=https://rubygems.org/gems/chef-vault/versions/2.8.0>chef-vault gem</a>:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>chef gem install chef-vault
</code></pre></div><p>And then ensure you have a .chef directory that connects to a chef server.</p><h2 id=creation>Creation</h2><p>Creating a vault is easy:</p><pre><code>knife vault create passwords root -S &quot;policy_name:webserver&quot; -A &quot;michael&quot; -J root.json -M client
</code></pre><p>For whatever reason the <code>knife vault</code>  command doesn&rsquo;t default to talk to a chef server. So to create a knife vault, you have to specify <code>-M client</code>  at the end. Or you can make your life easier going forward by adding this line to your knife.rb:</p><pre><code>knife[:vault_mode] = 'client'
</code></pre><p>For the command, I used this root.json:</p><pre><code>{
&quot;username&quot;: &quot;mhedgpeth&quot;,
&quot;password&quot;: &quot;myPassword&quot;
}
</code></pre><p>Let&rsquo;s review the options:</p><table><thead><tr><th>Team</th><th>Natural Alignment</th><th>Natural Misalignment</th></tr></thead><tbody><tr><td>Development</td><td>Faster Delivery of features</td><td>Have to be engaged in operations, more &ldquo;work&rdquo; to do</td></tr><tr><td>Operations</td><td>Less fires, more consistency</td><td>Have to learn a new skillset and be a beginner</td></tr><tr><td>Security</td><td>More consistency, compliance</td><td>Automation can cause unknown vulnerabilities</td></tr><tr><td>Business</td><td>Faster ROI for development, lower cost for operations, and a scale model that works</td><td>Takes ongoing investment in culture and tools</td></tr></tbody></table><p>This uploads two data bag items to a data bag called &ldquo;passwords&rdquo;:</p><ol><li><code>root</code> which has the data above</li><li><strong><code>root_keys</code></strong> which stores the metadata about which clients can read and edit this data bag (as you specified above in the search criteria and administrators list.</li></ol><h3 id=making-it-even-more-secure>Making it Even More Secure</h3><p><a href=https://coderanger.net/>Noah Kantrowitz</a> helped me understand the vulnerabilities of the above approach using the <code>-S</code>  flag. With that flag, you give the nodes the ability to define the criteria by which they are allowed to decrypt the vault. So if you say I want nodes that have <code>policy_name:webserver</code>  to decrypt this data, all it takes is someone saying they are <code>'policy_name:webserver'</code>  and they will be granted the keys.</p><p>A better way to handle this is through specifying each node explicitly through the -A flag. So your command would be:</p><pre><code>knife vault create passwords root -A &quot;michael,webserver1,webserver2&quot; -J root.json -M client
</code></pre><h2 id=viewing-a-vault>Viewing a Vault</h2><p>Now that we have created a vault, let&rsquo;s view it:</p><pre><code>knife vault show passwords root -M client
</code></pre><p>which will output:</p><pre><code>id: root
password: myPassword
username: mhedgpeth
</code></pre><p>It lets me view it in cleartext because I am one of the administrators on the vault itself. If I want, I can even view it in JSON if you want to move the file to another chef server:</p><pre><code>knife vault show passwords root -M client -Fjson
</code></pre><h2 id=viewing-encrypted-version>Viewing Encrypted Version</h2><p>To view the encrypted version of the vault, you can simply use the normal commands for viewing data bag, just realizing that the vault data bag also has a _keys one too:</p><pre><code>knife data bag show passwords root
</code></pre><p>and</p><pre><code>knife data bag show password root_keys
</code></pre><p>Will show you lots of encrypted goodness which I will not show. The keys is helpful to see what clients are connected to it.</p><h2 id=adding-nodes>Adding nodes</h2><p>Probably the weakest part of chef-vault is what to do when you add nodes. If you have an elastic situation this can be dicey, because when you add nodes, you have to run this command to generate keys for those nodes to read the encrypted data:</p><pre><code>knife vault refresh passwords root --clean-unknown-clients
</code></pre><p>This updates the <code>root_keys</code>  encrypted data bag with information on the nodes that now match the search criteria. So it&rsquo;s  important to know that the nodes that can read a vault is a snapshot in time based on the search criteria, not a dynamic list.</p><p>If you aren&rsquo;t using a search criteria, you&rsquo;ll need to add nodes to the administrators list itself:</p><pre><code>knife vault update passwords root -A 'newnode,newnode2'
</code></pre><h2 id=rotating-keys>Rotating keys</h2><p>You might want to rotate the key that encrypts the data in the data bag. The way this works is the clients use their own key as a private key to combine with the public key on the chef server to decrypt the data bag&rsquo;s key. That key encrypts the real data bag. This command will change that key:</p><pre><code>knife vault rotate all keys
</code></pre><h2 id=cookbook-development>Cookbook Development</h2><p>What use is a data bag without using it in a cookbook? To be able to deal with this data bag in the cookbook, include the <code>chef-vault::default</code>  recipe in your runlist. Then you will have the <code>chef_vault_item</code>  method that you can call like this:</p><pre><code>item = chef_vault_item(&quot;passwords&quot;, &quot;root&quot;)
password = item['password']
</code></pre><p>Using <code>chef_vault_item</code>  will make your cookbook more testable by test kitchen (see below).</p><h2 id=version-control>Version Control</h2><p>With data bags, we like to have a data_bags repository that we use to promote shared data and version control changes. This kind of thing doesn&rsquo;t work with chef-vault. Instead you get a small team that can update the vault and then have them manually do it. This isn&rsquo;t ideal, but secrets are hard and, as I wrote above, using a dedicated secrets management tool like Hashicorp Vault will keep you from that level of work.</p><h2 id=kitchen-support>Kitchen Support</h2><p>To make this work in kitchen, just put a cleartext data bag in the data_bags folder that your kitchen run refers to (probably in <code>test/integration/data_bags</code>). Then the vault commands fall back into using that dummy data when you use <code>chef_vault_item</code>  to retrieve it.</p><h2 id=conclusion>Conclusion</h2><p>The chef-vault functionality is compelling enough for serious consideration. Hopefully this walkthrough will help you decide if it is right for you.</p></div><section class="my-5 pt-10 pb-5 border-t border-gray-400 flex items-center"><img alt="Avatar photo" class="border border-gray-400 p-1 w-10 h-10 rounded-full mr-3" src=/images/michael.jpg>
<span class=flex-grow>Michael Hedgpeth</span>
<a href="http://twitter.com/share?url=https%3a%2f%2fhedge-ops.com%2fchef-vault-tutorial%2f&text=chef-vault%20Tutorial&via=michaelhedgpeth" class="text-white text-xs font-bold rounded-md no-underline flex items-center px-3 py-2 bg-twitter hover:color-white hover:opacity-75 no-underline"><svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Twitter</title><path d="M6.29 18.25c7.55.0 11.67-6.25 11.67-11.67v-.53c.8-.59 1.49-1.3 2.04-2.13-.75.33-1.54.55-2.36.65a4.12 4.12.0 001.8-2.27c-.8.48-1.68.81-2.6 1a4.1 4.1.0 00-7 3.74 11.65 11.65.0 01-8.45-4.3 4.1 4.1.0 001.27 5.49C2.01 8.2 1.37 8.03.8 7.7v.05a4.1 4.1.0 003.3 4.03 4.1 4.1.0 01-1.86.07 4.1 4.1.0 003.83 2.85A8.23 8.23.0 010 16.4a11.62 11.62.0 006.29 1.84"/></svg>Tweet</a></section><section class="my-5 py-5 relative"><h2>Interactions</h2></section></article><aside class=flex><a class="w-full md:w-1/2 flex flex-col items-center py-7 px-3 no-underline rounded-md hover:bg-white transition duration-300 ease-in-out" href=/chef-cookbook-builds-in-teamcity/><span class="border border-gray-6 text-xs rounded-md mb-2 uppercase font-bold py-2 px-3">Read this next</span>
<span class=text-center>Chef Cookbook Builds in TeamCity</span></a>
<a class="w-full md:w-1/2 flex flex-col items-center py-7 px-3 no-underline rounded-md hover:bg-white transition duration-300 ease-in-out" href=/the-power-of-precendence/><span class="border border-gray-6 text-xs rounded-md mb-2 uppercase font-bold py-2 px-3">You might enjoy</span>
<span class=text-center>The Power of Precendence</span></a></aside></main><footer class="w-full max-w-7xl mx-auto text-center border-t border-gray-200 py-9 px-3 mt-9 pin-b text-sm text-gray-500">Made with <a href=https://gohugo.io class="underline transition duration-300 ease-in-out hover:text-blue-600">Hugo</a> and <a href=https://github.com/leonardofaria/bento class="underline transition duration-300 ease-in-out hover:text-blue-600">Bento theme</a>.
Copyright © 2020 Michael Hedgpeth</footer><script>var initMenu=()=>{var navButtons=document.querySelectorAll('.nav-button');var navMenu=document.querySelector('#nav-menu');var navSocialLinks=document.querySelector('#nav-social-links');for(var button of navButtons){button.addEventListener('click',()=>{console.log('click')
navMenu.classList.toggle("hidden");if(navSocialLinks){navSocialLinks.classList.toggle("hidden");}
for(var navButton of navButtons){navButton.classList.toggle("hidden");};});}}
document.addEventListener('turbolinks:load',initMenu());</script><script>var initHeader=()=>{let scrollPos=window.scrollY;var header=document.querySelector('#header');var headerContainer=document.querySelector("#header-container");var readingProgressBar=document.querySelector("#reading-progress-bar");let scrollTop=0;let scrollBottom=0;let scrollPercent=0;var addClassOnScroll=()=>{header.classList.add("shadow");header.classList.add("bg-white-90");}
var removeClassOnScroll=()=>{header.classList.remove("shadow");header.classList.remove("bg-white-90");}
window.onscroll=function(){scrollPos=window.scrollY;scrollTop=document.documentElement["scrollTop"]||document.body["scrollTop"];scrollBottom=(document.documentElement["scrollHeight"]||document.body["scrollHeight"])-document.documentElement.clientHeight;scrollPercent=scrollTop/scrollBottom*100;readingProgressBar.style.width=(scrollTop/scrollBottom*100)+'%';if(scrollPos>0){addClassOnScroll()}
else{removeClassOnScroll()}}}
document.addEventListener('turbolinks:load',initHeader());</script></body></html>