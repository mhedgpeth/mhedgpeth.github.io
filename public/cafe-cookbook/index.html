<!doctype html><html prefix="og: http://ogp.me/ns#" lang=en-us><head itemscope itemtype=https://hedge-ops.com/><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:locale" content="en"><meta name=language content="en"><title itemprop=name>Cafe Cookbook &#183; Michael Hedgpeth</title><meta property="og:title" content="Cafe Cookbook &#183; Michael Hedgpeth"><meta name=twitter:title content="Cafe Cookbook &#183; Michael Hedgpeth"><meta itemprop=name content="Cafe Cookbook &#183; Michael Hedgpeth"><meta name=application-name content="Michael Hedgpeth"><meta property="og:site_name" content="Michael Hedgpeth"><base href=https://hedge-ops.com/cafe-cookbook/><link rel=canonical href=https://hedge-ops.com/cafe-cookbook/ itemprop=url><meta name=url content="https://hedge-ops.com/cafe-cookbook/"><meta name=twitter:url content="https://hedge-ops.com/cafe-cookbook/"><meta property="og:url" content="https://hedge-ops.com/cafe-cookbook/"><meta itemprop=image content="https://hedge-ops.com/images/michael.jpg"><meta property="og:image" content="https://hedge-ops.com/images/michael.jpg"><meta name=twitter:image content="https://hedge-ops.com/images/michael.jpg"><meta name=twitter:image:src content="https://hedge-ops.com/images/michael.jpg"><meta name=twitter:card content="summary_large_image"><meta property="og:type" content="article"><meta itemprop=description content="With a solid deployment pipeline in place for running Chef that depends on Cafe for a safe, atomic, and controlled rollout of Chef policy changes, it has become"><meta property="og:description" content="With a solid deployment pipeline in place for running Chef that depends on Cafe for a safe, atomic, and controlled rollout of Chef policy changes, it has become"><meta name=description content="With a solid deployment pipeline in place for running Chef that depends on Cafe for a safe, atomic, and controlled rollout of Chef policy changes, it has become"><meta name=twitter:description content="With a solid deployment pipeline in place for running Chef that depends on Cafe for a safe, atomic, and controlled rollout of Chef policy changes, it has become"><meta property="article:published_time" content="2017-05-17T00:00:00Z"><meta name=twitter:label1 value="Reading time"><meta name=twitter:data1 value="3 minutes"><meta name=twitter:label2 value=Published><meta name=twitter:data2 value="May 17, 2017"><meta property="article:tag" content="cafe"><meta property="article:tag" content="chef"><meta property="og:updated_time" content="2017-05-17T00:00:00Z"><meta property="og:article:author" content="Michael"><meta property="article:author" content="Michael"><meta name=author content="Michael"><meta name=generator content="Hugo 0.72.0"><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com/ crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel=stylesheet><link rel=stylesheet href=https://hedge-ops.com/css/styles.min.ef433e47a104e30937dfad230e28b6dd329c9b4fe18ff4925850da1f24df3133.css integrity="sha256-70M+R6EE4wk3360jDii23TKcm0/hj/SSWFDaHyTfMTM="><link href=/index.xml rel=alternate type=application/rss+xml title="Michael Hedgpeth"><script src=https://cdnjs.cloudflare.com/ajax/libs/turbolinks/5.2.0/turbolinks.js></script></head><body class="bg-gradient flex flex-col min-h-screen"><header id=header class="w-full m-0 fixed z-10 transition-all duration-300 ease-in-out border-t-4 border-gray-300 backdrop-filter-blur"><div id=header-container class="max-w-7xl mx-auto p-6 flex items-center flex-wrap lg:flex-no-wrap relative justify-between"><a href=https://hedge-ops.com/ class="tracking-tighter leading-10 text-3xl font-semibold text-gray-600 flex flex-shrink-0">Michael Hedgpeth</a><div class="block lg:hidden mx-2"><button class="nav-button w-10 h-10 justify-center flex items-center opacity-75 hover:opacity-100 transition duration-300 ease-in-out"><svg class="fill-current h-4 w-4" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"/></svg></button>
<button class="hidden nav-button w-10 h-10 justify-center flex items-center opacity-75 hover:opacity-100 transition duration-300 ease-in-out"><svg class="fill-current h-4 w-4" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Close menu</title><polygon points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2" transform="rotate(45 10 10)"/></svg></button></div><div class="absolute right-8 top-16 lg:relative lg:right-0 lg:top-0 flex flex-col lg:flex-row items-center rounded-md bg-white shadow lg:bg-transparent lg:shadow-none"><nav id=nav-social-links class="p-4 lg:p-0 text-gray-600 hidden lg:block lg:order-last w-full lg:w-auto lg:ml-3"><ul class="flex justify-end"><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Twitter href=https://www.twitter.com/michaelhedgpeth rel=me><svg class="fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Twitter</title><path d="M6.29 18.25c7.55.0 11.67-6.25 11.67-11.67v-.53c.8-.59 1.49-1.3 2.04-2.13-.75.33-1.54.55-2.36.65a4.12 4.12.0 001.8-2.27c-.8.48-1.68.81-2.6 1a4.1 4.1.0 00-7 3.74 11.65 11.65.0 01-8.45-4.3 4.1 4.1.0 001.27 5.49C2.01 8.2 1.37 8.03.8 7.7v.05a4.1 4.1.0 003.3 4.03 4.1 4.1.0 01-1.86.07 4.1 4.1.0 003.83 2.85A8.23 8.23.0 010 16.4a11.62 11.62.0 006.29 1.84"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Github href=https://www.github.com/mhedgpeth rel=me><svg class="fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>GitHub</title><path d="M10 0A10 10 0 006.84 19.49c.5.1.68-.22.68-.48l-.01-1.7c-2.78.6-3.37-1.34-3.37-1.34-.46-1.16-1.11-1.47-1.11-1.47-.9-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.9 1.52 2.34 1.08 2.91.83.1-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.94.0-1.1.39-1.99 1.03-2.69a3.6 3.6.0 01.1-2.64s.84-.27 2.75 1.02a9.58 9.58.0 015 0c1.91-1.3 2.75-1.02 2.75-1.02.55 1.37.2 2.4.1 2.64.64.7 1.03 1.6 1.03 2.69.0 3.84-2.34 4.68-4.57 4.93.36.31.68.92.68 1.85l-.01 2.75c0 .26.18.58.69.48A10 10 0 0010 0"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Linkedin href=https://linkedin.com/in/michael-hedgpeth rel=me><svg class="fill-current w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Feed href=/index.xml><svg class="fill-current w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>RSS</title><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg></a></li></ul></nav><nav id=nav-menu class="p-4 lg:p-0 hidden lg:block w-full lg:w-auto text-gray-600"><ul class="w-full flex flex-col lg:flex-row justify-end items-end lg:items-center"><li class="flex my-2 lg:my-2 mx-1 lg:mx-2"><a title=About class="uppercase font-bold lg:py-2 lg:px-3 rounded text-sm opacity-75 hover:opacity-100 transition duration-300 ease-in-out" href=/about>About</a></li><li class="flex my-2 lg:my-2 mx-1 lg:mx-2"><a title=Speaking class="uppercase font-bold lg:py-2 lg:px-3 rounded text-sm opacity-75 hover:opacity-100 transition duration-300 ease-in-out" href=/speaking>Speaking</a></li></ul></nav></div></div></header><main class="flex-1 mt-12 max-w-3xl mt-32 mx-auto text-gray-700 w-full"><div id=reading-progress-bar role=presentation class="fixed z-10 top-0 left-0 h-1 bg-gray-700"></div><article class=article><header class="text-center pt-10 pb-6"><small class="text-center text-sm"><time class=text-gray-500 datetime=2017-05-17T00:00:00+00:00>May 17, 2017</time>
<a href=https://hedge-ops.com/tags/chef/ class="inline-flex items-center px-4 py-1 rounded-full no-underline bg-orange-100 text-orange-800 hover:bg-orange-300 ml-4">chef</a>
<a href=https://hedge-ops.com/tags/cafe/ class="inline-flex items-center px-4 py-1 rounded-full no-underline bg-orange-100 text-orange-800 hover:bg-orange-300 ml-4">cafe</a></small><h1 class="leading-9 text-center"><a href=https://hedge-ops.com/cafe-cookbook/ class="no-underline inline-block text-black relative"><div class=dots aria-hidden=true></div>Cafe Cookbook</a></h1></header><div class=article__content><div class=full-width><img src=/images/feature-cafe-cookbook.jpg alt="Cafe Cookbook"></div><p>With a <a href=policyfile-deployment-with-cafe-and-psake>solid deployment pipeline</a> in place for running Chef that depends on <a href=/introducing-cafe/>Cafe</a> for a safe, atomic, and controlled rollout of Chef <a href=/policyfiles/>policy</a> changes, it has become more important than ever to utilize <a href=/introducing-cafe/>cafe</a> to manage itself and Chef on a machine. The <a href=https://github.com/mhedgpeth/cafe-cookbook><code>cafe</code> cookbook</a> does just that.</p><p>The cafe cookbook makes it easy to ensure that Cafe is installed and configured properly on a machine and will manage Chef upgrades that happen outside of when Chef runs.</p><p>It does this very easily by giving you access to two resources:</p><h2 id=cafe-resource><code>cafe</code> resource</h2><p>To install and configure Cafe, you should use the <code>cafe</code> resource, for example:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>cafe <span style=color:#d14>&#39;cafe&#39;</span> <span style=color:#000;font-weight:700>do</span>
  download_source <span style=color:#d14>&#39;https://github.com/mhedgpeth/cafe/releases/download/0.9.2-beta/cafe-win10-x64-0.9.2.0.zip&#39;</span>
  download_checksum <span style=color:#d14>&#39;75707978E48B51EC9564D209A9B6CA8F4B563AC4B128C34614435899FAD787C7&#39;</span>
  version <span style=color:#d14>&#39;0.9.2.0&#39;</span>
  installer <span style=color:#d14>&#39;cafe-win10-x64-0.9.2.0.zip&#39;</span>
  cafe_install_root <span style=color:#d14>&#39;D:&#39;</span>
  chef_interval <span style=color:#099>1800</span>
  service_port <span style=color:#099>59320</span>
<span style=color:#000;font-weight:700>end</span>
</code></pre></div><p>See the <a href=https://github.com/mhedgpeth/cafe/releases>Cafe Releases</a> page to get the <code>download_source</code>, <code>version</code>, and <code>installer</code> that you need to use. You&rsquo;ll have to calculate your own checksum at the moment. The last three properties are configuration elements of Cafe itself; if you omit them, the resource will use sensible default values.</p><p>You should also notice that this resource is very friendly to air-gapped environments; you can use any URL you need to use here, as long as you get it downloaded and it matches the checksum. We use <a href=https://www.jfrog.com/artifactory/>artifactory</a> for our artifacts and love it.</p><p>If you are introducing Cafe to existing Chef nodes because you want to manage Chef that way now, and your <code>cafe_install_root</code> is set to <code>D:</code>, it will dutifully install Cafe for the first time in <code>D:\chef</code>. On an upgrade, the <code>cafe</code> service asks its <code>cafe Updater</code> service friend to update <code>cafe</code> for it, because services can&rsquo;t update themselves. This all happens after the Chef run is finished, assuming that Cafe is running Chef.</p><h2 id=cafe_chef-resource><code>cafe_chef</code> resource</h2><p>You&rsquo;ll also want to keep the <code>chef-client</code> application up to date and consistent on all of your nodes. You&rsquo;ll want to make sure you do this when Chef is not running as well. Fortunately, Cafe has you covered in this regard. Simply declare what you want Chef to look like on the machine, and Cafe handles the rest:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>cafe_chef <span style=color:#d14>&#39;chef-client&#39;</span> <span style=color:#000;font-weight:700>do</span>
  download_source <span style=color:#d14>&#39;https://packages.chef.io/files/stable/chef/13.0.118/windows/2012r2/chef-client-13.0.118-1-x64.msi&#39;</span>
  installer <span style=color:#d14>&#39;chef-client-13.0.118-1-x64.msi&#39;</span>
  download_checksum <span style=color:#d14>&#39;c594965648e20a2339d6f33d236b4e3e22b2be6916cceb1b0f338c74378c03da&#39;</span>
  version <span style=color:#d14>&#39;13.0.118&#39;</span>
  cafe_install_root <span style=color:#d14>&#39;D:&#39;</span>
<span style=color:#000;font-weight:700>end</span>
</code></pre></div><p>As with the scenario above, you can use any source you want from a private repository like artifactory. This is the equivalent of running <code>cafe chef download 13.0.118</code> and then <code>cafe install chef 13.0.118</code> but gives you more control to download the file.</p><p>Also, you can omit the <code>cafe_install_root</code> if you want to install everything on <code>C:</code>.</p><p>It&rsquo;s important to understand what exactly is happening here, because this is at the genesis of why Cafe exists. You would expect Cafe to be <em>running</em> Chef at this moment, so you don&rsquo;t want it to upgrade Chef immediately. So here we&rsquo;re <strong>not</strong> upgrading Chef, we&rsquo;re <strong>requesting</strong> that Cafe upgrade Chef after the Chef client runs. The <em>desired state</em> of the system is &ldquo;I want Cafe to make the Chef client be on version 13.0.118&rdquo;. Cafe handles the rest!</p><p>So you don&rsquo;t need to worry about timing here. Cafe runs <strong>all</strong> of its jobs sequentially because it knows that you don&rsquo;t want things stepping on other things. So sleep peacefully, my friend!</p><h1 id=conclusion>Conclusion</h1><p>I hope you&rsquo;re as excited as I am about the promise Cafe brings to the Chef runtime. With Cafe, you can still use Chef to manage itself and Cafe on an application, but you can trust that Cafe will handle this management with grace and no drama. If you&rsquo;re interested in deploying or contributing to Cafe, I&rsquo;d love to hear from you about it. I think it addresses a critical need within the Chef ecosystem.</p></div><section class="my-5 pt-10 pb-5 border-t border-gray-400 flex items-center"><img alt="Avatar photo" class="border border-gray-400 p-1 w-10 h-10 rounded-full mr-3" src=/images/michael.jpg>
<span class=flex-grow>Michael Hedgpeth</span>
<a href="http://twitter.com/share?url=https%3a%2f%2fhedge-ops.com%2fcafe-cookbook%2f&text=Cafe%20Cookbook&via=michaelhedgpeth" class="text-white text-xs font-bold rounded-md no-underline flex items-center px-3 py-2 bg-twitter hover:color-white hover:opacity-75 no-underline"><svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Twitter</title><path d="M6.29 18.25c7.55.0 11.67-6.25 11.67-11.67v-.53c.8-.59 1.49-1.3 2.04-2.13-.75.33-1.54.55-2.36.65a4.12 4.12.0 001.8-2.27c-.8.48-1.68.81-2.6 1a4.1 4.1.0 00-7 3.74 11.65 11.65.0 01-8.45-4.3 4.1 4.1.0 001.27 5.49C2.01 8.2 1.37 8.03.8 7.7v.05a4.1 4.1.0 003.3 4.03 4.1 4.1.0 01-1.86.07 4.1 4.1.0 003.83 2.85A8.23 8.23.0 010 16.4a11.62 11.62.0 006.29 1.84"/></svg>Tweet</a></section><section class="my-5 py-5 relative"><h2>Interactions</h2></section></article><aside class=flex><a class="w-full md:w-1/2 flex flex-col items-center py-7 px-3 no-underline rounded-md hover:bg-white transition duration-300 ease-in-out" href=/chef-rollback/><span class="border border-gray-6 text-xs rounded-md mb-2 uppercase font-bold py-2 px-3">Read this next</span>
<span class=text-center>Chef Rollback with Policyfiles and Cafe</span></a>
<a class="w-full md:w-1/2 flex flex-col items-center py-7 px-3 no-underline rounded-md hover:bg-white transition duration-300 ease-in-out" href=/policyfile-deployment-with-cafe-and-psake/><span class="border border-gray-6 text-xs rounded-md mb-2 uppercase font-bold py-2 px-3">You might enjoy</span>
<span class=text-center>Policyfile Deployment with Cafe and Psake</span></a></aside></main><footer class="w-full max-w-7xl mx-auto text-center border-t border-gray-200 py-9 px-3 mt-9 pin-b text-sm text-gray-500">Made with <a href=https://gohugo.io class="underline transition duration-300 ease-in-out hover:text-blue-600">Hugo</a> and <a href=https://github.com/leonardofaria/bento class="underline transition duration-300 ease-in-out hover:text-blue-600">Bento theme</a>.
Copyright © 2020 Michael Hedgpeth</footer><script>var initMenu=()=>{var navButtons=document.querySelectorAll('.nav-button');var navMenu=document.querySelector('#nav-menu');var navSocialLinks=document.querySelector('#nav-social-links');for(var button of navButtons){button.addEventListener('click',()=>{console.log('click')
navMenu.classList.toggle("hidden");if(navSocialLinks){navSocialLinks.classList.toggle("hidden");}
for(var navButton of navButtons){navButton.classList.toggle("hidden");};});}}
document.addEventListener('turbolinks:load',initMenu());</script><script>var initHeader=()=>{let scrollPos=window.scrollY;var header=document.querySelector('#header');var headerContainer=document.querySelector("#header-container");var readingProgressBar=document.querySelector("#reading-progress-bar");let scrollTop=0;let scrollBottom=0;let scrollPercent=0;var addClassOnScroll=()=>{header.classList.add("shadow");header.classList.add("bg-white-90");}
var removeClassOnScroll=()=>{header.classList.remove("shadow");header.classList.remove("bg-white-90");}
window.onscroll=function(){scrollPos=window.scrollY;scrollTop=document.documentElement["scrollTop"]||document.body["scrollTop"];scrollBottom=(document.documentElement["scrollHeight"]||document.body["scrollHeight"])-document.documentElement.clientHeight;scrollPercent=scrollTop/scrollBottom*100;readingProgressBar.style.width=(scrollTop/scrollBottom*100)+'%';if(scrollPos>0){addClassOnScroll()}
else{removeClassOnScroll()}}}
document.addEventListener('turbolinks:load',initHeader());</script></body></html>