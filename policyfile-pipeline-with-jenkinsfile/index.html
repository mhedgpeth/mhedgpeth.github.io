<!doctype html><html prefix="og: http://ogp.me/ns#" lang=en-us><head itemscope itemtype=https://hedge-ops.com/><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:locale" content="en"><meta name=language content="en"><title itemprop=name>Policyfile Pipeline with Jenkinsfile &#183; Michael Hedgpeth</title><meta property="og:title" content="Policyfile Pipeline with Jenkinsfile &#183; Michael Hedgpeth"><meta name=twitter:title content="Policyfile Pipeline with Jenkinsfile &#183; Michael Hedgpeth"><meta itemprop=name content="Policyfile Pipeline with Jenkinsfile &#183; Michael Hedgpeth"><meta name=application-name content="Michael Hedgpeth"><meta property="og:site_name" content="Michael Hedgpeth"><base href=https://hedge-ops.com/policyfile-pipeline-with-jenkinsfile/><link rel=canonical href=https://hedge-ops.com/policyfile-pipeline-with-jenkinsfile/ itemprop=url><meta name=url content="https://hedge-ops.com/policyfile-pipeline-with-jenkinsfile/"><meta name=twitter:url content="https://hedge-ops.com/policyfile-pipeline-with-jenkinsfile/"><meta property="og:url" content="https://hedge-ops.com/policyfile-pipeline-with-jenkinsfile/"><meta itemprop=image content="https://hedge-ops.com/images/michael.jpg"><meta property="og:image" content="https://hedge-ops.com/images/michael.jpg"><meta name=twitter:image content="https://hedge-ops.com/images/michael.jpg"><meta name=twitter:image:src content="https://hedge-ops.com/images/michael.jpg"><meta name=twitter:card content="summary_large_image"><meta property="og:type" content="article"><meta itemprop=description content="I&amp;rsquo;m a huge proponent of policyfiles for managing Chef changes in all of your environments. Let&amp;rsquo;s talk a little about how we take a policyfile and cr"><meta property="og:description" content="I&amp;rsquo;m a huge proponent of policyfiles for managing Chef changes in all of your environments. Let&amp;rsquo;s talk a little about how we take a policyfile and cr"><meta name=description content="I&amp;rsquo;m a huge proponent of policyfiles for managing Chef changes in all of your environments. Let&amp;rsquo;s talk a little about how we take a policyfile and cr"><meta name=twitter:description content="I&amp;rsquo;m a huge proponent of policyfiles for managing Chef changes in all of your environments. Let&amp;rsquo;s talk a little about how we take a policyfile and cr"><meta property="article:published_time" content="2017-05-13T00:00:00Z"><meta name=twitter:label1 value="Reading time"><meta name=twitter:data1 value="5 minutes"><meta name=twitter:label2 value=Published><meta name=twitter:data2 value="May 13, 2017"><meta property="article:tag" content="chef"><meta property="og:updated_time" content="2017-05-13T00:00:00Z"><meta property="og:article:author" content="Michael"><meta property="article:author" content="Michael"><meta name=author content="Michael"><meta name=generator content="Hugo 0.72.0"><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com/ crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel=stylesheet><link rel=stylesheet href=https://hedge-ops.com/css/styles.min.ef433e47a104e30937dfad230e28b6dd329c9b4fe18ff4925850da1f24df3133.css integrity="sha256-70M+R6EE4wk3360jDii23TKcm0/hj/SSWFDaHyTfMTM="><link href=/index.xml rel=alternate type=application/rss+xml title="Michael Hedgpeth"><script src=https://cdnjs.cloudflare.com/ajax/libs/turbolinks/5.2.0/turbolinks.js></script></head><body class="bg-gradient flex flex-col min-h-screen"><header id=header class="w-full m-0 fixed z-10 transition-all duration-300 ease-in-out border-t-4 border-gray-300 backdrop-filter-blur"><div id=header-container class="max-w-7xl mx-auto p-6 flex items-center flex-wrap lg:flex-no-wrap relative justify-between"><a href=https://hedge-ops.com/ class="tracking-tighter leading-10 text-3xl font-semibold text-gray-600 flex flex-shrink-0">Michael Hedgpeth</a><div class="block lg:hidden mx-2"><button class="nav-button w-10 h-10 justify-center flex items-center opacity-75 hover:opacity-100 transition duration-300 ease-in-out"><svg class="fill-current h-4 w-4" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"/></svg></button>
<button class="hidden nav-button w-10 h-10 justify-center flex items-center opacity-75 hover:opacity-100 transition duration-300 ease-in-out"><svg class="fill-current h-4 w-4" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Close menu</title><polygon points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2" transform="rotate(45 10 10)"/></svg></button></div><div class="absolute right-8 top-16 lg:relative lg:right-0 lg:top-0 flex flex-col lg:flex-row items-center rounded-md bg-white shadow lg:bg-transparent lg:shadow-none"><nav id=nav-social-links class="p-4 lg:p-0 text-gray-600 hidden lg:block lg:order-last w-full lg:w-auto lg:ml-3"><ul class="flex justify-end"><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Twitter href=https://www.twitter.com/michaelhedgpeth rel=me><svg class="fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Twitter</title><path d="M6.29 18.25c7.55.0 11.67-6.25 11.67-11.67v-.53c.8-.59 1.49-1.3 2.04-2.13-.75.33-1.54.55-2.36.65a4.12 4.12.0 001.8-2.27c-.8.48-1.68.81-2.6 1a4.1 4.1.0 00-7 3.74 11.65 11.65.0 01-8.45-4.3 4.1 4.1.0 001.27 5.49C2.01 8.2 1.37 8.03.8 7.7v.05a4.1 4.1.0 003.3 4.03 4.1 4.1.0 01-1.86.07 4.1 4.1.0 003.83 2.85A8.23 8.23.0 010 16.4a11.62 11.62.0 006.29 1.84"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Github href=https://www.github.com/mhedgpeth rel=me><svg class="fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>GitHub</title><path d="M10 0A10 10 0 006.84 19.49c.5.1.68-.22.68-.48l-.01-1.7c-2.78.6-3.37-1.34-3.37-1.34-.46-1.16-1.11-1.47-1.11-1.47-.9-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.9 1.52 2.34 1.08 2.91.83.1-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.94.0-1.1.39-1.99 1.03-2.69a3.6 3.6.0 01.1-2.64s.84-.27 2.75 1.02a9.58 9.58.0 015 0c1.91-1.3 2.75-1.02 2.75-1.02.55 1.37.2 2.4.1 2.64.64.7 1.03 1.6 1.03 2.69.0 3.84-2.34 4.68-4.57 4.93.36.31.68.92.68 1.85l-.01 2.75c0 .26.18.58.69.48A10 10 0 0010 0"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Linkedin href=https://linkedin.com/in/michael-hedgpeth rel=me><svg class="fill-current w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Feed href=/index.xml><svg class="fill-current w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>RSS</title><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg></a></li></ul></nav><nav id=nav-menu class="p-4 lg:p-0 hidden lg:block w-full lg:w-auto text-gray-600"><ul class="w-full flex flex-col lg:flex-row justify-end items-end lg:items-center"><li class="flex my-2 lg:my-2 mx-1 lg:mx-2"><a title=About class="uppercase font-bold lg:py-2 lg:px-3 rounded text-sm opacity-75 hover:opacity-100 transition duration-300 ease-in-out" href=/about>About</a></li><li class="flex my-2 lg:my-2 mx-1 lg:mx-2"><a title=Speaking class="uppercase font-bold lg:py-2 lg:px-3 rounded text-sm opacity-75 hover:opacity-100 transition duration-300 ease-in-out" href=/speaking>Speaking</a></li></ul></nav></div></div></header><main class="flex-1 mt-12 max-w-3xl mt-32 mx-auto text-gray-700 w-full"><div id=reading-progress-bar role=presentation class="fixed z-10 top-0 left-0 h-1 bg-gray-700"></div><article class=article><header class="text-center pt-10 pb-6"><small class="text-center text-sm"><time class=text-gray-500 datetime=2017-05-13T00:00:00+00:00>May 13, 2017</time>
<a href=https://hedge-ops.com/tags/chef/ class="inline-flex items-center px-4 py-1 rounded-full no-underline bg-orange-100 text-orange-800 hover:bg-orange-300 ml-4">chef</a></small><h1 class="leading-9 text-center"><a href=https://hedge-ops.com/policyfile-pipeline-with-jenkinsfile/ class="no-underline inline-block text-black relative"><div class=dots aria-hidden=true></div>Policyfile Pipeline with Jenkinsfile</a></h1></header><div class=article__content><div class=full-width><img src=/images/feature-policyfile-pipeline-with-jenkinsfile.jpg alt="Policyfile Pipeline with Jenkinsfile"></div><p>I&rsquo;m a huge proponent of <a href=/policyfiles/>policyfiles</a> for managing Chef changes in all of your environments. Let&rsquo;s talk a little about how we take a policyfile and create a pipeline in Jenkins around it to get it deployed to the right places.</p><p>Many environments that aren&rsquo;t as security-conscious will have a single Chef Server to rule them all, connected to a single CI server. This is the model that <a href=https://docs.chef.io/workflow.html>Chef Workflow</a> assumes, and it&rsquo;s a nice situation to be in. In those situations, the pipeline I lay out will be much simpler, but I still recommend following the basic pieces. Since it&rsquo;s more complicated and therefore covers all the bases, we&rsquo;ll go for a disconnected, releasable pipeline that can and will traverse the development to operations barrier that many security-minded organizations have.</p><p>For our policyfiles pipeline, we create a similar process to our cookbooks:</p><ol><li>We keep a separate <code>policies</code> git repo for each product group of policies that we have. <strong>We don&rsquo;t keep the policyfiles in the cookbook.</strong> This is largely because we want to have our own pipeline for policies that is <strong>unrelated</strong> to the cookbook pipeline. The cookbook pipeline will promote a cookbook to a <em>supermarket</em>, and the policy will pull the cookbook <em>from</em> that supermarket. This creates two separate processes that have a beginning and end, but are disconnected, so allow for independence. This is a critical aspect to designing any pipeline, and one I&rsquo;ll blog about in the near future.</li><li>We have a <code>rakefile</code> for doing tasks that can be done locally on a developer machine</li><li>We then put that into a pipeline with a <code>Jenkinsfile</code>.</li></ol><p>Let&rsquo;s first look at the <code>rakefile</code>:</p><h1 id=policyfile-rakefile>Policyfile Rakefile</h1><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#0086b3>require</span> <span style=color:#d14>&#39;rake/clean&#39;</span>
<span style=color:#0086b3>require</span> <span style=color:#d14>&#39;rake/packagetask&#39;</span>
<span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>product_name</span>
  <span style=color:#d14>&#39;myproduct&#39;</span>
<span style=color:#000;font-weight:700>end</span>

<span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>policies</span>
  <span style=color:teal>FileList</span><span style=color:#000;font-weight:700>[</span><span style=color:#d14>&#34;</span><span style=color:#d14>#{</span>product_name<span style=color:#d14>}</span><span style=color:#d14>-*.rb&#34;</span><span style=color:#000;font-weight:700>]</span>
<span style=color:#000;font-weight:700>end</span>

<span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>policies_version</span>(build_number)
  <span style=color:#d14>&#34;1.</span><span style=color:#d14>#{</span>build_number<span style=color:#d14>}</span><span style=color:#d14>.0&#34;</span>
<span style=color:#000;font-weight:700>end</span>

<span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>archive_name</span>
  build_number <span style=color:#000;font-weight:700>=</span> <span style=color:teal>ENV</span><span style=color:#000;font-weight:700>[</span><span style=color:#d14>&#39;BUILD_ID&#39;</span><span style=color:#000;font-weight:700>]</span>
  <span style=color:#000;font-weight:700>if</span> build_number<span style=color:#000;font-weight:700>.</span>nil?
    <span style=color:#d14>&#34;</span><span style=color:#d14>#{</span>product_name<span style=color:#d14>}</span><span style=color:#d14>_policies.zip&#34;</span>
  <span style=color:#000;font-weight:700>else</span>
    <span style=color:#d14>&#34;</span><span style=color:#d14>#{</span>product_name<span style=color:#d14>}</span><span style=color:#d14>_policies_</span><span style=color:#d14>#{</span>policies_version(build_number)<span style=color:#d14>}</span><span style=color:#d14>.zip&#34;</span>
  <span style=color:#000;font-weight:700>end</span>
<span style=color:#000;font-weight:700>end</span>

task <span style=color:#990073>:default</span> <span style=color:#000;font-weight:700>=&gt;</span> <span style=color:#000;font-weight:700>[</span><span style=color:#990073>:compile_policies</span><span style=color:#000;font-weight:700>]</span>

desc <span style=color:#d14>&#34;compiles all policies&#34;</span>
task <span style=color:#990073>:compile_policies</span> <span style=color:#000;font-weight:700>do</span> 
  rm <span style=color:teal>Dir</span><span style=color:#000;font-weight:700>.</span>glob(<span style=color:#d14>&#39;*.lock.json&#39;</span>)
  policies<span style=color:#000;font-weight:700>.</span>each <span style=color:#000;font-weight:700>do</span> <span style=color:#000;font-weight:700>|</span>policyfile<span style=color:#000;font-weight:700>|</span>
    sh <span style=color:#d14>&#39;chef&#39;</span>, <span style=color:#d14>&#39;install&#39;</span>, policyfile
  <span style=color:#000;font-weight:700>end</span>
<span style=color:#000;font-weight:700>end</span>

directory <span style=color:#d14>&#39;staging&#39;</span>

<span style=color:teal>CLEAN</span><span style=color:#000;font-weight:700>.</span>include(<span style=color:#d14>&#39;staging&#39;</span>)
<span style=color:teal>CLEAN</span><span style=color:#000;font-weight:700>.</span>include(<span style=color:#d14>&#39;*.zip&#39;</span>)

desc <span style=color:#d14>&#34;Exports all policies to archives and stages them in the archive folder&#34;</span>
task <span style=color:#990073>:export_policies</span> <span style=color:#000;font-weight:700>=&gt;</span> <span style=color:#d14>&#39;staging&#39;</span> <span style=color:#000;font-weight:700>do</span>
  policies<span style=color:#000;font-weight:700>.</span>each <span style=color:#000;font-weight:700>do</span> <span style=color:#000;font-weight:700>|</span>policyfile<span style=color:#000;font-weight:700>|</span>
    sh <span style=color:#d14>&#39;chef&#39;</span>, <span style=color:#d14>&#39;export&#39;</span>, policyfile, <span style=color:#d14>&#39;staging&#39;</span>, <span style=color:#d14>&#39;-a&#39;</span>
  <span style=color:#000;font-weight:700>end</span>
<span style=color:#000;font-weight:700>end</span>

<span style=color:#0086b3>require</span> <span style=color:#d14>&#39;os&#39;</span>

task <span style=color:#990073>:stage</span> <span style=color:#000;font-weight:700>=&gt;</span> <span style=color:#000;font-weight:700>[</span><span style=color:#990073>:clean</span>, <span style=color:#d14>&#39;staging&#39;</span>, <span style=color:#990073>:export_policies</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>do</span>
  cp <span style=color:#d14>&#39;deploy.ps1&#39;</span>, <span style=color:#d14>&#39;staging&#39;</span>
  cp <span style=color:#d14>&#39;psake.psm1&#39;</span>, <span style=color:#d14>&#39;staging&#39;</span>
  cp <span style=color:#d14>&#39;psake.psd1&#39;</span>, <span style=color:#d14>&#39;staging&#39;</span>
  cp <span style=color:#d14>&#39;psake.ps1&#39;</span>, <span style=color:#d14>&#39;staging&#39;</span>
<span style=color:#000;font-weight:700>end</span>

task <span style=color:#990073>:package</span> <span style=color:#000;font-weight:700>=&gt;</span> <span style=color:#000;font-weight:700>[</span><span style=color:#990073>:stage</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>do</span>
  cd(<span style=color:#d14>&#39;staging&#39;</span>) <span style=color:#000;font-weight:700>do</span>
    <span style=color:#000;font-weight:700>if</span> <span style=color:teal>OS</span><span style=color:#000;font-weight:700>.</span>windows?
      sh <span style=color:#d14>&#39;C:\Program Files\7-Zip\7z.exe&#39;</span>, <span style=color:#d14>&#39;a&#39;</span>, <span style=color:#d14>&#39;-tzip&#39;</span>, archive_name, <span style=color:#d14>&#39;*.*&#39;</span>, <span style=color:#d14>&#39;-x!*.zip&#39;</span>
    <span style=color:#000;font-weight:700>else</span>
      sh <span style=color:#d14>&#39;zip&#39;</span>, <span style=color:#d14>&#39;-r&#39;</span>, archive_name, <span style=color:#d14>&#39;.&#39;</span>, <span style=color:#d14>&#39;-x&#39;</span>, <span style=color:#d14>&#39;*.zip&#39;</span>
    <span style=color:#000;font-weight:700>end</span>
  <span style=color:#000;font-weight:700>end</span>
<span style=color:#000;font-weight:700>end</span>
</code></pre></div><p>Let&rsquo;s unpack this a little bit. Here&rsquo;s what&rsquo;s going on:</p><ol><li><strong>compile_poilcies</strong> will run <code>chef install</code> against all files that have the pattern <code>myproduct-*.rb</code>. So it basicaly generates the <code>Policyfile.lock.json</code> for all the policies in the repo.</li><li><strong>export_policies</strong> will export all policies to a <code>tgz</code> file with <code>chef export</code> command.</li><li><strong>stage</strong> will stage all the things that are to be packaged into a <code>staging</code> folder including the deployment scripts written in psake (more on that in the next post).</li><li><strong>package</strong> will package the <code>tgz</code> file and the deployment scripts into a package</li></ol><h1 id=policyfile-jenkinsfile>Policyfile Jenkinsfile</h1><p>Now that we have a rakefile that can do the work we need, now it&rsquo;s time to get that into a <code>Jenkinsfile</code> to describe the pipeline. The pipeline will create a package of all policyfile archives and put them, with the script that will deploy them, on our artifactory server. Here&rsquo;s an example:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=color:#999;font-weight:700;font-style:italic>#!/usr/bin/env groovy</span>
<span style=color:#458;font-weight:700>def</span> repository <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;myproduct-policies&#39;</span>
<span style=color:#458;font-weight:700>def</span> workingDirectory <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;policies/${repository}&#34;</span>
<span style=color:#998;font-style:italic>// the current branch that is being built
</span><span style=color:#998;font-style:italic></span><span style=color:#458;font-weight:700>def</span> currentBranch <span style=color:#000;font-weight:700>=</span> env<span style=color:#000;font-weight:700>.</span><span style=color:teal>BRANCH_NAME</span>
<span style=color:#458;font-weight:700>def</span> <span style=color:#900;font-weight:700>execute</span><span style=color:#000;font-weight:700>(</span>command<span style=color:#000;font-weight:700>){</span>
  ansiColor<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;xterm&#39;</span><span style=color:#000;font-weight:700>){</span>
    bat command
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
stage<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;Checkout&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
  node<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;windows&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
    checkout<span style=color:#000;font-weight:700>([</span>$class<span style=color:#000;font-weight:700>:</span> <span style=color:#d14>&#39;GitSCM&#39;</span><span style=color:#000;font-weight:700>,</span>
              <span style=color:#900;font-weight:700>branches:</span> scm<span style=color:#000;font-weight:700>.</span><span style=color:teal>branches</span><span style=color:#000;font-weight:700>,</span>
              <span style=color:#900;font-weight:700>doGenerateSubmoduleConfigurations:</span> scm<span style=color:#000;font-weight:700>.</span><span style=color:teal>doGenerateSubmoduleConfigurations</span><span style=color:#000;font-weight:700>,</span>
              <span style=color:#900;font-weight:700>extensions:</span> scm<span style=color:#000;font-weight:700>.</span><span style=color:teal>extensions</span> <span style=color:#000;font-weight:700>+</span> <span style=color:#000;font-weight:700>[[</span>$class<span style=color:#000;font-weight:700>:</span> <span style=color:#d14>&#39;RelativeTargetDirectory&#39;</span><span style=color:#000;font-weight:700>,</span>
                            <span style=color:#900;font-weight:700>relativeTargetDir:</span> workingDirectory<span style=color:#000;font-weight:700>],</span> <span style=color:#000;font-weight:700>[</span>$class<span style=color:#000;font-weight:700>:</span> <span style=color:#d14>&#39;LocalBranch&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#900;font-weight:700>localBranch:</span> currentBranch<span style=color:#000;font-weight:700>]],</span>
              <span style=color:#900;font-weight:700>userRemoteConfigs:</span> scm<span style=color:#000;font-weight:700>.</span><span style=color:teal>userRemoteConfigs</span>
     <span style=color:#000;font-weight:700>])</span>
    dir<span style=color:#000;font-weight:700>(</span>workingDirectory<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
      execute<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;rake -t clean&#39;</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000;font-weight:700>}</span>
    stash <span style=color:#900;font-weight:700>name:</span> <span style=color:#d14>&#39;everything&#39;</span><span style=color:#000;font-weight:700>,</span>
          <span style=color:#900;font-weight:700>includes:</span> <span style=color:#d14>&#39;**&#39;</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
stage<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;Compile&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
  node<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;windows&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
    unstash <span style=color:#d14>&#39;everything&#39;</span>
    dir<span style=color:#000;font-weight:700>(</span>workingDirectory<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
      execute<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;rake -t compile_policies&#39;</span><span style=color:#000;font-weight:700>)</span>
      <span style=color:#000;font-weight:700>try</span> <span style=color:#000;font-weight:700>{</span>
        execute<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;git add *.lock.json&#39;</span><span style=color:#000;font-weight:700>)</span>
        execute<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;git commit -m \&#34;Automatically Compiled Policyfiles\&#34;&#34;</span><span style=color:#000;font-weight:700>)</span>
        withCredentials<span style=color:#000;font-weight:700>([[</span>$class<span style=color:#000;font-weight:700>:</span> <span style=color:#d14>&#39;UsernamePasswordMultiBinding&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#900;font-weight:700>credentialsId:</span> <span style=color:#d14>&#39;abcYOUR_GUID_HERE123&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#900;font-weight:700>usernameVariable:</span> <span style=color:#d14>&#39;GIT_USERNAME&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#900;font-weight:700>passwordVariable:</span> <span style=color:#d14>&#39;GIT_PASSWORD&#39;</span><span style=color:#000;font-weight:700>]])</span> <span style=color:#000;font-weight:700>{</span>
          execute<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;git push http://${env.GIT_USERNAME}:${env.GIT_PASSWORD}@almgit.ncr.com/scm/chef/${repository}.git ${currentBranch}&#34;</span><span style=color:#000;font-weight:700>)</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>catch</span><span style=color:#000;font-weight:700>(</span>error<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
        echo <span style=color:#d14>&#34;Nothing to commit because of error: ${error}, so skipping pushing&#34;</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
    stash <span style=color:#900;font-weight:700>name:</span> <span style=color:#d14>&#39;compiled&#39;</span><span style=color:#000;font-weight:700>,</span>
          <span style=color:#900;font-weight:700>includes:</span> <span style=color:#d14>&#39;**&#39;</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
stage<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;Package&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
  node<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;windows&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
    unstash <span style=color:#d14>&#39;compiled&#39;</span>
    dir<span style=color:#000;font-weight:700>(</span>workingDirectory<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
      execute<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;rake -t package&#39;</span><span style=color:#000;font-weight:700>)</span>
      archiveArtifacts <span style=color:#d14>&#39;staging/*.zip&#39;</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
stage<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;Publish&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
  node<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;windows&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
    unstash <span style=color:#d14>&#39;compiled&#39;</span>
    dir<span style=color:#000;font-weight:700>(</span>workingDirectory<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
      execute<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;jfrog.exe rt upload &#34;staging\\\\*.zip&#34; myproduct-repo/myproduct-policies/&#39;</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>

</code></pre></div><p>Here is a description of all the stages:</p><table><thead><tr><th>Stage</th><th>Description</th></tr></thead><tbody><tr><td>Checkout</td><td>Checks out the policies repo</td></tr><tr><td>Compile</td><td>Generates all policyfile.lock.json files and checks them into git</td></tr><tr><td>Package</td><td>Creates tgz files and zips them up with deployment scripts</td></tr><tr><td>Publish</td><td>Publishes this all to artifactory</td></tr></tbody></table><p>You can see a pattern here with the pipelines from the earlier post on <a href=/cookbook-development-with-rakefile/>cookbook build</a> and <a href=/cookbook-pipeline-with-jenkinsfile/>cookbook pipelines</a>. They rely on script that can run locally, then end up being deployed to something that is a source of the next step in the process. More on that in the next post: how we deploy these policies to a Chef Server and reconverge the nodes.</p><h1 id=conclusion>Conclusion</h1><p>Hopefully you&rsquo;re starting to see the pattern I use when designing a pipeline element in my Chef Pipeline. Everything has a starting point and a destination. Every pipeline <em>segment</em> will take a &ldquo;stable&rdquo; input and put it into an &ldquo;even more stable&rdquo; location at the end. It all flows together very quickly and then allows for quick changes that can flow to production.</p></div><section class="my-5 pt-10 pb-5 border-t border-gray-400 flex items-center"><img alt="Avatar photo" class="border border-gray-400 p-1 w-10 h-10 rounded-full mr-3" src=/images/michael.jpg>
<span class=flex-grow>Michael Hedgpeth</span>
<a href="http://twitter.com/share?url=https%3a%2f%2fhedge-ops.com%2fpolicyfile-pipeline-with-jenkinsfile%2f&text=Policyfile%20Pipeline%20with%20Jenkinsfile&via=michaelhedgpeth" class="text-white text-xs font-bold rounded-md no-underline flex items-center px-3 py-2 bg-twitter hover:color-white hover:opacity-75 no-underline"><svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Twitter</title><path d="M6.29 18.25c7.55.0 11.67-6.25 11.67-11.67v-.53c.8-.59 1.49-1.3 2.04-2.13-.75.33-1.54.55-2.36.65a4.12 4.12.0 001.8-2.27c-.8.48-1.68.81-2.6 1a4.1 4.1.0 00-7 3.74 11.65 11.65.0 01-8.45-4.3 4.1 4.1.0 001.27 5.49C2.01 8.2 1.37 8.03.8 7.7v.05a4.1 4.1.0 003.3 4.03 4.1 4.1.0 01-1.86.07 4.1 4.1.0 003.83 2.85A8.23 8.23.0 010 16.4a11.62 11.62.0 006.29 1.84"/></svg>Tweet</a></section><section class="my-5 py-5 relative"><h2>Interactions</h2></section></article><aside class=flex><a class="w-full md:w-1/2 flex flex-col items-center py-7 px-3 no-underline rounded-md hover:bg-white transition duration-300 ease-in-out" href=/policyfile-deployment-with-cafe-and-psake/><span class="border border-gray-6 text-xs rounded-md mb-2 uppercase font-bold py-2 px-3">Read this next</span>
<span class=text-center>Policyfile Deployment with Cafe and Psake</span></a>
<a class="w-full md:w-1/2 flex flex-col items-center py-7 px-3 no-underline rounded-md hover:bg-white transition duration-300 ease-in-out" href=/cookbook-pipeline-with-jenkinsfile/><span class="border border-gray-6 text-xs rounded-md mb-2 uppercase font-bold py-2 px-3">You might enjoy</span>
<span class=text-center>Cookbook Pipeline with Jenkinsfile</span></a></aside></main><footer class="w-full max-w-7xl mx-auto text-center border-t border-gray-200 py-9 px-3 mt-9 pin-b text-sm text-gray-500">Made with <a href=https://gohugo.io class="underline transition duration-300 ease-in-out hover:text-blue-600">Hugo</a> and <a href=https://github.com/leonardofaria/bento class="underline transition duration-300 ease-in-out hover:text-blue-600">Bento theme</a>.
Copyright Â© 2020 Michael Hedgpeth</footer><script>var initMenu=()=>{var navButtons=document.querySelectorAll('.nav-button');var navMenu=document.querySelector('#nav-menu');var navSocialLinks=document.querySelector('#nav-social-links');for(var button of navButtons){button.addEventListener('click',()=>{console.log('click')
navMenu.classList.toggle("hidden");if(navSocialLinks){navSocialLinks.classList.toggle("hidden");}
for(var navButton of navButtons){navButton.classList.toggle("hidden");};});}}
document.addEventListener('turbolinks:load',initMenu());</script><script>var initHeader=()=>{let scrollPos=window.scrollY;var header=document.querySelector('#header');var headerContainer=document.querySelector("#header-container");var readingProgressBar=document.querySelector("#reading-progress-bar");let scrollTop=0;let scrollBottom=0;let scrollPercent=0;var addClassOnScroll=()=>{header.classList.add("shadow");header.classList.add("bg-white-90");}
var removeClassOnScroll=()=>{header.classList.remove("shadow");header.classList.remove("bg-white-90");}
window.onscroll=function(){scrollPos=window.scrollY;scrollTop=document.documentElement["scrollTop"]||document.body["scrollTop"];scrollBottom=(document.documentElement["scrollHeight"]||document.body["scrollHeight"])-document.documentElement.clientHeight;scrollPercent=scrollTop/scrollBottom*100;readingProgressBar.style.width=(scrollTop/scrollBottom*100)+'%';if(scrollPos>0){addClassOnScroll()}
else{removeClassOnScroll()}}}
document.addEventListener('turbolinks:load',initHeader());</script></body></html>