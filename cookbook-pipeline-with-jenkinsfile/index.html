<!doctype html><html prefix="og: http://ogp.me/ns#" lang=en-us><head itemscope itemtype=https://hedge-ops.com/><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:locale" content="en"><meta name=language content="en"><title itemprop=name>Cookbook Pipeline with Jenkinsfile &#183; Michael Hedgpeth</title><meta property="og:title" content="Cookbook Pipeline with Jenkinsfile &#183; Michael Hedgpeth"><meta name=twitter:title content="Cookbook Pipeline with Jenkinsfile &#183; Michael Hedgpeth"><meta itemprop=name content="Cookbook Pipeline with Jenkinsfile &#183; Michael Hedgpeth"><meta name=application-name content="Michael Hedgpeth"><meta property="og:site_name" content="Michael Hedgpeth"><base href=https://hedge-ops.com/cookbook-pipeline-with-jenkinsfile/><link rel=canonical href=https://hedge-ops.com/cookbook-pipeline-with-jenkinsfile/ itemprop=url><meta name=url content="https://hedge-ops.com/cookbook-pipeline-with-jenkinsfile/"><meta name=twitter:url content="https://hedge-ops.com/cookbook-pipeline-with-jenkinsfile/"><meta property="og:url" content="https://hedge-ops.com/cookbook-pipeline-with-jenkinsfile/"><meta itemprop=image content="https://hedge-ops.com/images/michael.jpg"><meta property="og:image" content="https://hedge-ops.com/images/michael.jpg"><meta name=twitter:image content="https://hedge-ops.com/images/michael.jpg"><meta name=twitter:image:src content="https://hedge-ops.com/images/michael.jpg"><meta name=twitter:card content="summary_large_image"><meta property="og:type" content="article"><meta itemprop=description content="Now that we have a local cookbook build ready to go, it&amp;rsquo;s time to get that in a CI environment. I have been a fan of TeamCity and my friends at Chef have"><meta property="og:description" content="Now that we have a local cookbook build ready to go, it&amp;rsquo;s time to get that in a CI environment. I have been a fan of TeamCity and my friends at Chef have"><meta name=description content="Now that we have a local cookbook build ready to go, it&amp;rsquo;s time to get that in a CI environment. I have been a fan of TeamCity and my friends at Chef have"><meta name=twitter:description content="Now that we have a local cookbook build ready to go, it&amp;rsquo;s time to get that in a CI environment. I have been a fan of TeamCity and my friends at Chef have"><meta property="article:published_time" content="2017-05-12T00:00:00Z"><meta name=twitter:label1 value="Reading time"><meta name=twitter:data1 value="5 minutes"><meta name=twitter:label2 value=Published><meta name=twitter:data2 value="May 12, 2017"><meta property="article:tag" content="chef"><meta property="og:updated_time" content="2017-05-12T00:00:00Z"><meta property="og:article:author" content="Michael"><meta property="article:author" content="Michael"><meta name=author content="Michael"><meta name=generator content="Hugo 0.72.0"><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com/ crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel=stylesheet><link rel=stylesheet href=https://hedge-ops.com/css/styles.min.ef433e47a104e30937dfad230e28b6dd329c9b4fe18ff4925850da1f24df3133.css integrity="sha256-70M+R6EE4wk3360jDii23TKcm0/hj/SSWFDaHyTfMTM="><link href=/index.xml rel=alternate type=application/rss+xml title="Michael Hedgpeth"><script src=https://cdnjs.cloudflare.com/ajax/libs/turbolinks/5.2.0/turbolinks.js></script></head><body class="bg-gradient flex flex-col min-h-screen"><header id=header class="w-full m-0 fixed z-10 transition-all duration-300 ease-in-out border-t-4 border-gray-300 backdrop-filter-blur"><div id=header-container class="max-w-7xl mx-auto p-6 flex items-center flex-wrap lg:flex-no-wrap relative justify-between"><a href=https://hedge-ops.com/ class="tracking-tighter leading-10 text-3xl font-semibold text-gray-600 flex flex-shrink-0">Michael Hedgpeth</a><div class="block lg:hidden mx-2"><button class="nav-button w-10 h-10 justify-center flex items-center opacity-75 hover:opacity-100 transition duration-300 ease-in-out"><svg class="fill-current h-4 w-4" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"/></svg></button>
<button class="hidden nav-button w-10 h-10 justify-center flex items-center opacity-75 hover:opacity-100 transition duration-300 ease-in-out"><svg class="fill-current h-4 w-4" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Close menu</title><polygon points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2" transform="rotate(45 10 10)"/></svg></button></div><div class="absolute right-8 top-16 lg:relative lg:right-0 lg:top-0 flex flex-col lg:flex-row items-center rounded-md bg-white shadow lg:bg-transparent lg:shadow-none"><nav id=nav-social-links class="p-4 lg:p-0 text-gray-600 hidden lg:block lg:order-last w-full lg:w-auto lg:ml-3"><ul class="flex justify-end"><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Twitter href=https://www.twitter.com/michaelhedgpeth rel=me><svg class="fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Twitter</title><path d="M6.29 18.25c7.55.0 11.67-6.25 11.67-11.67v-.53c.8-.59 1.49-1.3 2.04-2.13-.75.33-1.54.55-2.36.65a4.12 4.12.0 001.8-2.27c-.8.48-1.68.81-2.6 1a4.1 4.1.0 00-7 3.74 11.65 11.65.0 01-8.45-4.3 4.1 4.1.0 001.27 5.49C2.01 8.2 1.37 8.03.8 7.7v.05a4.1 4.1.0 003.3 4.03 4.1 4.1.0 01-1.86.07 4.1 4.1.0 003.83 2.85A8.23 8.23.0 010 16.4a11.62 11.62.0 006.29 1.84"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Github href=https://www.github.com/mhedgpeth rel=me><svg class="fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>GitHub</title><path d="M10 0A10 10 0 006.84 19.49c.5.1.68-.22.68-.48l-.01-1.7c-2.78.6-3.37-1.34-3.37-1.34-.46-1.16-1.11-1.47-1.11-1.47-.9-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.9 1.52 2.34 1.08 2.91.83.1-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.94.0-1.1.39-1.99 1.03-2.69a3.6 3.6.0 01.1-2.64s.84-.27 2.75 1.02a9.58 9.58.0 015 0c1.91-1.3 2.75-1.02 2.75-1.02.55 1.37.2 2.4.1 2.64.64.7 1.03 1.6 1.03 2.69.0 3.84-2.34 4.68-4.57 4.93.36.31.68.92.68 1.85l-.01 2.75c0 .26.18.58.69.48A10 10 0 0010 0"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Linkedin href=https://linkedin.com/in/michael-hedgpeth rel=me><svg class="fill-current w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg></a></li><li><a class="block p-2 opacity-75 hover:opacity-100 transition duration-300 ease-in-out" title=Feed href=/index.xml><svg class="fill-current w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>RSS</title><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg></a></li></ul></nav><nav id=nav-menu class="p-4 lg:p-0 hidden lg:block w-full lg:w-auto text-gray-600"><ul class="w-full flex flex-col lg:flex-row justify-end items-end lg:items-center"><li class="flex my-2 lg:my-2 mx-1 lg:mx-2"><a title=About class="uppercase font-bold lg:py-2 lg:px-3 rounded text-sm opacity-75 hover:opacity-100 transition duration-300 ease-in-out" href=/about>About</a></li><li class="flex my-2 lg:my-2 mx-1 lg:mx-2"><a title=Speaking class="uppercase font-bold lg:py-2 lg:px-3 rounded text-sm opacity-75 hover:opacity-100 transition duration-300 ease-in-out" href=/speaking>Speaking</a></li></ul></nav></div></div></header><main class="flex-1 mt-12 max-w-3xl mt-32 mx-auto text-gray-700 w-full"><div id=reading-progress-bar role=presentation class="fixed z-10 top-0 left-0 h-1 bg-gray-700"></div><article class=article><header class="text-center pt-10 pb-6"><small class="text-center text-sm"><time class=text-gray-500 datetime=2017-05-12T00:00:00+00:00>May 12, 2017</time>
<a href=https://hedge-ops.com/tags/chef/ class="inline-flex items-center px-4 py-1 rounded-full no-underline bg-orange-100 text-orange-800 hover:bg-orange-300 ml-4">chef</a></small><h1 class="leading-9 text-center"><a href=https://hedge-ops.com/cookbook-pipeline-with-jenkinsfile/ class="no-underline inline-block text-black relative"><div class=dots aria-hidden=true></div>Cookbook Pipeline with Jenkinsfile</a></h1></header><div class=article__content><div class=full-width><img src=/images/feature-cookbook-pipeline-with-jenkinsfile.jpg alt="Pipeline with Jenkinsfile"></div><p>Now that we have a <a href=/cookbook-development-with-rakefile/>local cookbook build</a> ready to go, it&rsquo;s time to get that in a CI environment. I have been a fan of <a href=https://www.jetbrains.com/teamcity>TeamCity</a> and my friends at Chef have a done a great job with <a href=https://docs.chef.io/workflow.html>Chef Workflow in Automate</a>. For us, however, <a href=https://jenkins.io/>Jenkins</a> is our tool of choice with managing our deployment pipelines, for a few reasons:</p><ol><li>Jenkins is <strong>free</strong>. We are able to get done what we need inside of the free version, so it&rsquo;s nice that we don&rsquo;t have or need a license or support.</li><li>Jenkins is <strong>flexible</strong>. We have complicated requirements around security, and Jenkins has been easy to bend to those requirements without requiring a lot of fuss.</li><li>Jenkins is <strong>friendly to a pipeline mindset</strong>. Compared to TeamCity, Jenkins is much better at laying out a workflow and walking through the various stages of that workflow, defined in a single file.</li><li>Jenkins is <strong>recommended by expensive consultants</strong>. In a large enterprise that&rsquo;s important. If you go with a tool that the high-powered consultants don&rsquo;t put on a &ldquo;here&rsquo;s what people are doing&rdquo; list, you end up fighting an uphill battle. Choose those battles wisely; you&rsquo;ll likely lose them unless you have a <em>very</em> compelling use case.</li></ol><p>So now that we&rsquo;ve decided on Jenkins as our CI of choice, let&rsquo;s talk about how we would implement that.</p><h1 id=jenkinsfile-example>Jenkinsfile Example</h1><p>First, in your cookbook repository in git you would have a <code>Jenkinsfile</code>. Ours looks like this (just scroll down if you don&rsquo;t care; it&rsquo;s ok):</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=color:#999;font-weight:700;font-style:italic>#!/usr/bin/env groovy</span>
<span style=color:#998;font-style:italic>// COOKBOOK BUILD SETTINGS
</span><span style=color:#998;font-style:italic></span>
<span style=color:#998;font-style:italic>// name of this cookbook
</span><span style=color:#998;font-style:italic></span><span style=color:#458;font-weight:700>def</span> cookbook <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;cafe&#39;</span>

<span style=color:#998;font-style:italic>// SUPERMARKET SETTINGS
</span><span style=color:#998;font-style:italic>// the branch that should be promoted to supermarket
</span><span style=color:#998;font-style:italic></span><span style=color:#458;font-weight:700>def</span> stableBranch <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;master&#39;</span>
<span style=color:#998;font-style:italic>// the current branch that is being built
</span><span style=color:#998;font-style:italic></span><span style=color:#458;font-weight:700>def</span> currentBranch <span style=color:#000;font-weight:700>=</span> env<span style=color:#000;font-weight:700>.</span><span style=color:teal>BRANCH_NAME</span>

<span style=color:#998;font-style:italic>// OTHER (Unchanged)
</span><span style=color:#998;font-style:italic>// the checkout directory for the cookbook; usually not changed
</span><span style=color:#998;font-style:italic></span><span style=color:#458;font-weight:700>def</span> cookbookDirectory <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;cookbooks/${cookbook}&#34;</span>

<span style=color:#998;font-style:italic>// Everything below should not change unless you have a good reason :slightly_smiling_face:
</span><span style=color:#998;font-style:italic></span><span style=color:#458;font-weight:700>def</span> building_pull_request <span style=color:#000;font-weight:700>=</span> env<span style=color:#000;font-weight:700>.</span><span style=color:teal>pullRequestId</span> <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>null</span>

<span style=color:#458;font-weight:700>def</span> <span style=color:#900;font-weight:700>notify_stash</span><span style=color:#000;font-weight:700>(</span>building_pull_request<span style=color:#000;font-weight:700>){</span>
  <span style=color:#000;font-weight:700>if</span><span style=color:#000;font-weight:700>(</span>building_pull_request<span style=color:#000;font-weight:700>){</span>
    step<span style=color:#000;font-weight:700>([</span>$class<span style=color:#000;font-weight:700>:</span> <span style=color:#d14>&#39;StashNotifier&#39;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#900;font-weight:700>commitSha1:</span> <span style=color:#d14>&#34;${env.sourceCommitHash}&#34;</span><span style=color:#000;font-weight:700>])</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#458;font-weight:700>def</span> <span style=color:#900;font-weight:700>execute</span><span style=color:#000;font-weight:700>(</span>command<span style=color:#000;font-weight:700>){</span>
  ansiColor<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;xterm&#39;</span><span style=color:#000;font-weight:700>){</span>
    bat command
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#458;font-weight:700>def</span> <span style=color:#900;font-weight:700>rake</span><span style=color:#000;font-weight:700>(</span>command<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
  execute<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;chef exec rake -t ${command}&#34;</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#458;font-weight:700>def</span> <span style=color:#900;font-weight:700>fetch</span><span style=color:#000;font-weight:700>(</span>scm<span style=color:#000;font-weight:700>,</span> cookbookDirectory<span style=color:#000;font-weight:700>,</span> currentBranch<span style=color:#000;font-weight:700>){</span>
  checkout<span style=color:#000;font-weight:700>([</span>$class<span style=color:#000;font-weight:700>:</span> <span style=color:#d14>&#39;GitSCM&#39;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#900;font-weight:700>branches:</span> scm<span style=color:#000;font-weight:700>.</span><span style=color:teal>branches</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#900;font-weight:700>doGenerateSubmoduleConfigurations:</span> scm<span style=color:#000;font-weight:700>.</span><span style=color:teal>doGenerateSubmoduleConfigurations</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#900;font-weight:700>extensions:</span> scm<span style=color:#000;font-weight:700>.</span><span style=color:teal>extensions</span> <span style=color:#000;font-weight:700>+</span> <span style=color:#000;font-weight:700>[</span>
      <span style=color:#000;font-weight:700>[</span>$class<span style=color:#000;font-weight:700>:</span> <span style=color:#d14>&#39;RelativeTargetDirectory&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#900;font-weight:700>relativeTargetDir:</span> cookbookDirectory<span style=color:#000;font-weight:700>],</span>
      <span style=color:#000;font-weight:700>[</span>$class<span style=color:#000;font-weight:700>:</span> <span style=color:#d14>&#39;CleanBeforeCheckout&#39;</span><span style=color:#000;font-weight:700>],</span>
      <span style=color:#000;font-weight:700>[</span>$class<span style=color:#000;font-weight:700>:</span> <span style=color:#d14>&#39;LocalBranch&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#900;font-weight:700>localBranch:</span> currentBranch<span style=color:#000;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>],</span>
    <span style=color:#900;font-weight:700>userRemoteConfigs:</span> scm<span style=color:#000;font-weight:700>.</span><span style=color:teal>userRemoteConfigs</span>
  <span style=color:#000;font-weight:700>])</span>
<span style=color:#000;font-weight:700>}</span>

stage<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;Lint&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
  node<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;windows&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
    notify_stash<span style=color:#000;font-weight:700>(</span>building_pull_request<span style=color:#000;font-weight:700>)</span>

    echo <span style=color:#d14>&#34;cookbook: ${cookbook}&#34;</span>
    echo <span style=color:#d14>&#34;current branch: ${currentBranch}&#34;</span>
    echo <span style=color:#d14>&#34;checkout directory: ${cookbookDirectory}&#34;</span>
    <span style=color:#000;font-weight:700>try</span><span style=color:#000;font-weight:700>{</span>
      fetch<span style=color:#000;font-weight:700>(</span>scm<span style=color:#000;font-weight:700>,</span> cookbookDirectory<span style=color:#000;font-weight:700>,</span> currentBranch<span style=color:#000;font-weight:700>)</span>
      dir<span style=color:#000;font-weight:700>(</span>cookbookDirectory<span style=color:#000;font-weight:700>){</span>
        <span style=color:#998;font-style:italic>// clean out any old artifacts from the cookbook directory including the berksfile.lock file
</span><span style=color:#998;font-style:italic></span>        rake<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;clean&#39;</span><span style=color:#000;font-weight:700>)</span>
      <span style=color:#000;font-weight:700>}</span>

     dir<span style=color:#000;font-weight:700>(</span>cookbookDirectory<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#000;font-weight:700>try</span> <span style=color:#000;font-weight:700>{</span>
          rake<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;style&#39;</span><span style=color:#000;font-weight:700>)</span>
        <span style=color:#000;font-weight:700>}</span>
        <span style=color:#000;font-weight:700>finally</span> <span style=color:#000;font-weight:700>{</span>
          step<span style=color:#000;font-weight:700>([</span>$class<span style=color:#000;font-weight:700>:</span> <span style=color:#d14>&#39;CheckStylePublisher&#39;</span><span style=color:#000;font-weight:700>,</span>
                <span style=color:#900;font-weight:700>canComputeNew:</span> <span style=color:#000;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span>
                <span style=color:#900;font-weight:700>defaultEncoding:</span> <span style=color:#d14>&#39;&#39;</span><span style=color:#000;font-weight:700>,</span>
                <span style=color:#900;font-weight:700>healthy:</span> <span style=color:#d14>&#39;&#39;</span><span style=color:#000;font-weight:700>,</span>
                <span style=color:#900;font-weight:700>pattern:</span> <span style=color:#d14>&#39;**/reports/xml/checkstyle-result.xml&#39;</span><span style=color:#000;font-weight:700>,</span>
                <span style=color:#900;font-weight:700>unHealthy:</span> <span style=color:#d14>&#39;&#39;</span><span style=color:#000;font-weight:700>])</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>}</span>
      currentBuild<span style=color:#000;font-weight:700>.</span><span style=color:teal>result</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;SUCCESS&#39;</span>
    <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>catch</span><span style=color:#000;font-weight:700>(</span>err<span style=color:#000;font-weight:700>){</span>
      currentBuild<span style=color:#000;font-weight:700>.</span><span style=color:teal>result</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;FAILED&#39;</span>
      notify_stash<span style=color:#000;font-weight:700>(</span>building_pull_request<span style=color:#000;font-weight:700>)</span>
      <span style=color:#000;font-weight:700>throw</span> err
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>

stage<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;Unit Test&#39;</span><span style=color:#000;font-weight:700>){</span>
  node<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;windows&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000;font-weight:700>try</span> <span style=color:#000;font-weight:700>{</span>
      fetch<span style=color:#000;font-weight:700>(</span>scm<span style=color:#000;font-weight:700>,</span> cookbookDirectory<span style=color:#000;font-weight:700>,</span> currentBranch<span style=color:#000;font-weight:700>)</span>
      dir<span style=color:#000;font-weight:700>(</span>cookbookDirectory<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
        rake<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;test:berks_install&#39;</span><span style=color:#000;font-weight:700>)</span>
        rake<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;test:unit&#39;</span><span style=color:#000;font-weight:700>)</span>
        currentBuild<span style=color:#000;font-weight:700>.</span><span style=color:teal>result</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;SUCCESS&#39;</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>catch</span><span style=color:#000;font-weight:700>(</span>err<span style=color:#000;font-weight:700>){</span>
      currentBuild<span style=color:#000;font-weight:700>.</span><span style=color:teal>result</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;FAILED&#39;</span>
      notify_stash<span style=color:#000;font-weight:700>(</span>building_pull_request<span style=color:#000;font-weight:700>)</span>
      <span style=color:#000;font-weight:700>throw</span> err
    <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>finally</span> <span style=color:#000;font-weight:700>{</span>
      junit <span style=color:#900;font-weight:700>allowEmptyResults:</span> <span style=color:#000;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span> <span style=color:#900;font-weight:700>testResults:</span> <span style=color:#d14>&#39;**/rspec.xml&#39;</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>

stage<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;Functional (Kitchen)&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
  node<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;kitchen&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000;font-weight:700>try</span><span style=color:#000;font-weight:700>{</span>
      fetch<span style=color:#000;font-weight:700>(</span>scm<span style=color:#000;font-weight:700>,</span> cookbookDirectory<span style=color:#000;font-weight:700>,</span> currentBranch<span style=color:#000;font-weight:700>)</span>
      dir<span style=color:#000;font-weight:700>(</span>cookbookDirectory<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
        rake<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;test:kitchen:all&#39;</span><span style=color:#000;font-weight:700>)</span>
      <span style=color:#000;font-weight:700>}</span>
      currentBuild<span style=color:#000;font-weight:700>.</span><span style=color:teal>result</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;SUCCESS&#39;</span>
    <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>catch</span><span style=color:#000;font-weight:700>(</span>err<span style=color:#000;font-weight:700>){</span>
      currentBuild<span style=color:#000;font-weight:700>.</span><span style=color:teal>result</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#39;FAILED&#39;</span>
    <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>finally</span> <span style=color:#000;font-weight:700>{</span>
      notify_stash<span style=color:#000;font-weight:700>(</span>building_pull_request<span style=color:#000;font-weight:700>)</span>
      dir<span style=color:#000;font-weight:700>(</span>cookbookDirectory<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
        rake<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;test:kitchen:destroy&#39;</span><span style=color:#000;font-weight:700>)</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>currentBranch <span style=color:#000;font-weight:700>==</span> stableBranch<span style=color:#000;font-weight:700>){</span>
  lock<span style=color:#000;font-weight:700>(</span>cookbook<span style=color:#000;font-weight:700>){</span>
    stage <span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;Promote to Supermarket&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
      node<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;kitchen&#39;</span><span style=color:#000;font-weight:700>){</span>
        fetch<span style=color:#000;font-weight:700>(</span>scm<span style=color:#000;font-weight:700>,</span> cookbookDirectory<span style=color:#000;font-weight:700>,</span> currentBranch<span style=color:#000;font-weight:700>)</span>
        dir<span style=color:#000;font-weight:700>(</span>cookbookDirectory<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
          execute <span style=color:#d14>&#34;git branch --set-upstream ${currentBranch} origin/${currentBranch}&#34;</span>
          rake<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;release&#39;</span><span style=color:#000;font-weight:700>)</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>You can see here that the <code>Jenkinsfile</code> is acting more like an integration point to the <code>rakefile</code>. That&rsquo;s how we like it; we want as much as possible to be reproducible locally. Then we walk through the stages and do the things. Here is a more detailed explanation of the stages:</p><table><thead><tr><th>Stage</th><th>Description</th></tr></thead><tbody><tr><td>Lint</td><td>Checks that the code meets our guidelines</td></tr><tr><td>Unit Test</td><td>Runs chef unit tests on the cookbook, if any exist</td></tr><tr><td>Functional (Kitchen)</td><td>Runs test kitchen against all suites</td></tr><tr><td>Promote to Supermarket</td><td>Promotes the cookbook to an internal supermarket</td></tr></tbody></table><p>This provides a very simple way for cookbooks to go from a checkin to the supermarket.</p><h2 id=setting-this-up-in-jenkins>Setting this up in Jenkins</h2><p>In Jenkins we create two builds:</p><ol><li>A <a href=https://jenkins.io/doc/book/pipeline/>pipeline</a> build that builds off of <code>master</code>. Notice that we <strong>don&rsquo;t</strong> use the multi-branch pipeline build at the moment, because we were having quality issues with that feature in Jenkins and wanted to test our pull requests.</li><li>A <a href=https://wiki.jenkins-ci.org/display/JENKINS/Stash+pullrequest+builder+plugin>pull request</a> builder that tests pull requests in our local <a href=https://www.atlassian.com/software/bitbucket>bitbucket</a> server.</li></ol><p>The pull requests inside of bitbucket are set to not allow acceptance without a passing build, so this keeps our <code>master</code> branch clean and ready to go. Just in case, the <code>master</code> build will build everything before sending the cookbook off to the supermarket.</p><p>You&rsquo;ll also notice that the <code>Jenkinsfile</code> has a lot of <code>try/catch</code> logic in it. This is so the <code>Jenkinsfile</code> can notify the pull request verifier that a build failed, and that message will show up inside of the pull request. So you get some complexity here, but great benefit with having nice integration with your pull request workflow.</p><p>Once pull requests are solid, it&rsquo;s now time to lock down your master branch. Don&rsquo;t let a lot of people commit directly to it; instead have them submit pull requests. This follows the normal open source model that products like Chef use, and you&rsquo;ll find that it works very well.</p><h1 id=conclusion>Conclusion</h1><p>With a solid cookbook build in place and a CI process, things start to get regularly tested and quality goes up. I had to be persuaded by my colleagues to go the pull request verifier route, but now that I have, I see what they were trying to tell me: pull requests get tested, master is solid, and your speed of delivery goes up. Maybe one day the Jenkins blue ocean project will catch up to Bitbucket integration, but until then, this works pretty nice for us.</p><p>I&rsquo;d like to also thank and credit my colleagues <a href=http://kerryhouse.net/>John Kerry</a> and Richard Godbee for leading me in this direction. They spent a ton of time helping me understand how to make a good workflow in Jenkins, and the outline above would not be possible if it weren&rsquo;t for their help.</p></div><section class="my-5 pt-10 pb-5 border-t border-gray-400 flex items-center"><img alt="Avatar photo" class="border border-gray-400 p-1 w-10 h-10 rounded-full mr-3" src=/images/michael.jpg>
<span class=flex-grow>Michael Hedgpeth</span>
<a href="http://twitter.com/share?url=https%3a%2f%2fhedge-ops.com%2fcookbook-pipeline-with-jenkinsfile%2f&text=Cookbook%20Pipeline%20with%20Jenkinsfile&via=michaelhedgpeth" class="text-white text-xs font-bold rounded-md no-underline flex items-center px-3 py-2 bg-twitter hover:color-white hover:opacity-75 no-underline"><svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Twitter</title><path d="M6.29 18.25c7.55.0 11.67-6.25 11.67-11.67v-.53c.8-.59 1.49-1.3 2.04-2.13-.75.33-1.54.55-2.36.65a4.12 4.12.0 001.8-2.27c-.8.48-1.68.81-2.6 1a4.1 4.1.0 00-7 3.74 11.65 11.65.0 01-8.45-4.3 4.1 4.1.0 001.27 5.49C2.01 8.2 1.37 8.03.8 7.7v.05a4.1 4.1.0 003.3 4.03 4.1 4.1.0 01-1.86.07 4.1 4.1.0 003.83 2.85A8.23 8.23.0 010 16.4a11.62 11.62.0 006.29 1.84"/></svg>Tweet</a></section><section class="my-5 py-5 relative"><h2>Interactions</h2></section></article><aside class=flex><a class="w-full md:w-1/2 flex flex-col items-center py-7 px-3 no-underline rounded-md hover:bg-white transition duration-300 ease-in-out" href=/policyfile-pipeline-with-jenkinsfile/><span class="border border-gray-6 text-xs rounded-md mb-2 uppercase font-bold py-2 px-3">Read this next</span>
<span class=text-center>Policyfile Pipeline with Jenkinsfile</span></a>
<a class="w-full md:w-1/2 flex flex-col items-center py-7 px-3 no-underline rounded-md hover:bg-white transition duration-300 ease-in-out" href=/cookbook-development-with-rakefile/><span class="border border-gray-6 text-xs rounded-md mb-2 uppercase font-bold py-2 px-3">You might enjoy</span>
<span class=text-center>Cookbook Development with Rakefiles</span></a></aside></main><footer class="w-full max-w-7xl mx-auto text-center border-t border-gray-200 py-9 px-3 mt-9 pin-b text-sm text-gray-500">Made with <a href=https://gohugo.io class="underline transition duration-300 ease-in-out hover:text-blue-600">Hugo</a> and <a href=https://github.com/leonardofaria/bento class="underline transition duration-300 ease-in-out hover:text-blue-600">Bento theme</a>.
Copyright © 2020 Michael Hedgpeth</footer><script>var initMenu=()=>{var navButtons=document.querySelectorAll('.nav-button');var navMenu=document.querySelector('#nav-menu');var navSocialLinks=document.querySelector('#nav-social-links');for(var button of navButtons){button.addEventListener('click',()=>{console.log('click')
navMenu.classList.toggle("hidden");if(navSocialLinks){navSocialLinks.classList.toggle("hidden");}
for(var navButton of navButtons){navButton.classList.toggle("hidden");};});}}
document.addEventListener('turbolinks:load',initMenu());</script><script>var initHeader=()=>{let scrollPos=window.scrollY;var header=document.querySelector('#header');var headerContainer=document.querySelector("#header-container");var readingProgressBar=document.querySelector("#reading-progress-bar");let scrollTop=0;let scrollBottom=0;let scrollPercent=0;var addClassOnScroll=()=>{header.classList.add("shadow");header.classList.add("bg-white-90");}
var removeClassOnScroll=()=>{header.classList.remove("shadow");header.classList.remove("bg-white-90");}
window.onscroll=function(){scrollPos=window.scrollY;scrollTop=document.documentElement["scrollTop"]||document.body["scrollTop"];scrollBottom=(document.documentElement["scrollHeight"]||document.body["scrollHeight"])-document.documentElement.clientHeight;scrollPercent=scrollTop/scrollBottom*100;readingProgressBar.style.width=(scrollTop/scrollBottom*100)+'%';if(scrollPos>0){addClassOnScroll()}
else{removeClassOnScroll()}}}
document.addEventListener('turbolinks:load',initHeader());</script></body></html>